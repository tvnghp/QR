<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <title>Agribank Chi nhánh Cần Thơ II • Công cụ QR địa chỉ</title>
  <link rel="icon" href="agribank-logo.png" type="image/png">
  <link rel="apple-touch-icon" href="agribank-logo.png">
  <style>
  :root{
    --primary:#8B0000; --primary-600:#660000; --primary-400:#A52A2A; --primary-200:#CD5C5C;
    --accent:#DAA520; --accent-light:#F0E68C;
    --bg:#ffffff; --text:#1f1f1f; --muted:#666; --border:#e8e8e8; --thead-bg:#FFF5F5;
    --success:#228B22; --warning:#FF8C00; --danger:#DC143C;
  }
  *{box-sizing:border-box}
  html{height:100%; -webkit-text-size-adjust:100%; text-size-adjust:100%;}
  body{height:100%;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:linear-gradient(135deg, #fff, #FFF5F5);color:var(--text);min-height:100vh}
  body.no-scroll{overflow:hidden}
  
  /* Scrollbar tùy chỉnh */
  ::-webkit-scrollbar { width: 12px; height: 12px; }
  ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 6px; }
  ::-webkit-scrollbar-thumb { background: var(--primary-200); border-radius: 6px; border: 2px solid #f1f1f1; }
  ::-webkit-scrollbar-thumb:hover { background: var(--primary-400); }

    /* Header */
      header.hero{display:flex;align-items:center;justify-content:center;padding:12px 20px;border-bottom:3px solid var(--primary);background:linear-gradient(135deg, #fff, #FFF5F5);box-shadow:0 2px 15px rgba(139,0,0,0.1)}
  header.hero .logo{height:64px;width:64px;object-fit:contain;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.1));display:flex;align-items:center;justify-content:center}
  header.hero .title{text-align:center;display:flex;flex-direction:column;justify-content:center;align-items:center;min-height:64px}
  header.hero h1{margin:0;font-size:22px;line-height:1.1;letter-spacing:.8px;text-transform:uppercase;color:var(--primary);text-shadow:0 1px 2px rgba(0,0,0,0.1)}
  header.hero h3{margin:4px 0 0;font-size:20px;line-height:1.1;font-weight:800;color:var(--primary);letter-spacing:1px;text-transform:uppercase;text-shadow:0 1px 2px rgba(0,0,0,0.1)}
  header.hero .ghost{width:48px;height:48px}

  main{max-width:1100px;margin:20px auto;padding:0 16px}

  .card{background:#fff;border:1px solid var(--border);border-radius:16px;padding:20px;margin-bottom:20px;box-shadow:0 4px 20px rgba(139,0,0,0.08);transition:all 0.3s ease;border-left:4px solid var(--primary)}
  .card:hover{box-shadow:0 6px 25px rgba(139,0,0,0.12);transform:translateY(-2px)}
  .card h2{color:var(--primary);margin-top:0;margin-bottom:16px;font-size:20px;font-weight:700;border-bottom:2px solid var(--accent);padding-bottom:8px}

  label{display:block;font-weight:600;margin:8px 0 6px}
  input[type="text"],input[type="password"],input[type="url"],textarea{
    width:100%;padding:14px 16px;border:2px solid var(--border);border-radius:12px;font-size:16px;min-height:48px;
    transition:all 0.3s ease;background:#fff;
    -webkit-appearance:none;appearance:none;touch-action:manipulation
  }
  input:focus,textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 4px rgba(139,0,0,0.15);transform:translateY(-1px)}
  input:hover,textarea:hover{border-color:var(--primary-200)}

  .grid{display:grid;gap:12px}
  .grid.cols-3{grid-template-columns:repeat(3,1fr)}
  .grid.cols-2{grid-template-columns:repeat(2,1fr)}

  .actions{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
  button{
    cursor:pointer;border:0;padding:14px 18px;border-radius:12px;font-weight:700;letter-spacing:.3px;min-height:48px;
    -webkit-tap-highlight-color:transparent;transition:all 0.3s ease;font-size:15px;position:relative;overflow:hidden;
    -webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;
    touch-action:manipulation
  }
  button::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.2),transparent);transition:left 0.5s}
  button:hover::before{left:100%}
  .btn-primary{background:linear-gradient(135deg, var(--primary), var(--primary-600));color:#fff;box-shadow:0 4px 15px rgba(139,0,0,0.3)}
  .btn-primary:hover{background:linear-gradient(135deg, var(--primary-600), var(--primary));box-shadow:0 6px 20px rgba(139,0,0,0.4);transform:translateY(-2px)}
  .btn-secondary{background:#fff;color:var(--primary);border:2px solid var(--primary);box-shadow:0 2px 10px rgba(139,0,0,0.1)}
  .btn-secondary:hover{background:var(--primary);color:#fff;box-shadow:0 4px 15px rgba(139,0,0,0.2);transform:translateY(-1px)}
  .btn-danger{background:linear-gradient(135deg, var(--danger), #B22222);color:#fff;box-shadow:0 4px 15px rgba(220,20,60,0.3)}
  .btn-danger:hover{background:linear-gradient(135deg, #B22222, var(--danger));box-shadow:0 6px 20px rgba(220,20,60,0.4);transform:translateY(-2px)}

  .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
  .toolbar .spacer{flex:1}

  /* Bảng + wrapper kéo ngang trên mobile */
  .table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch;border-radius:16px;border:2px solid var(--border);background:#fff;box-shadow:0 4px 20px rgba(139,0,0,0.08)}
  table{width:100%;border-collapse:separate;border-spacing:0}
  thead th{background:linear-gradient(135deg, var(--thead-bg), #FFF8F8);color:var(--primary);font-weight:700;position:sticky;top:0;z-index:1;padding:14px 12px;font-size:14px;border-bottom:2px solid var(--primary-200)}
  th,td{padding:12px 12px;border-bottom:1px solid var(--border);text-align:left;font-size:14px;vertical-align:top;white-space:nowrap}
  tbody tr:nth-child(even){background:#fefefe}
  tbody tr:hover{background:linear-gradient(90deg, #FFF5F5, #FFF8F8);transform:scale(1.01);transition:all 0.2s ease}
  /* Địa chỉ trong LIST: xuống nhiều dòng nhưng không vượt quá chiều cao QR */
  .addr-wrap{white-space:normal;line-height:1.35;max-height:96px;overflow-y:auto;overflow-x:hidden;word-break:break-word;overflow-wrap:anywhere;width:100%}
  /* Ưu tiên độ rộng nhiều hơn cho cột Địa chỉ để chữ không bị bó hẹp */
  th.addr-col, td.addr-col{width:clamp(280px,32%,520px);min-width:280px}
  /* Căn giữa cột Link Maps */
  th.link-col, td.link-col{ text-align:center }

  .code{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .qr{
  width:96px; height:96px;
  object-fit:contain;
  border:1px solid var(--border);
  border-radius:0;            /* ← không bo góc thumbnail */
  background:#fff;
  image-rendering: pixelated; /* ← giữ ô QR sắc, dễ quét */
}
@media (min-width:720px){
  .qr{ width:96px; height:96px; }
}
  .empty{color:#777;font-style:italic;padding:12px}
  a{color:var(--primary);text-decoration:none}
  .muted{color:var(--muted);font-size:12px}
  .inline-btns button{padding:8px 10px;border-radius:8px}
  .inline-btns .sep{color:#bbb}

  .tip{background:linear-gradient(135deg, #FFF8DC, #F0E68C);border:2px solid var(--accent);padding:12px 16px;border-radius:12px;color:#8B4513;box-shadow:0 2px 10px rgba(218,165,32,0.2)}
  /* Tip toàn bề ngang card (full khung) */
  .tip-wide{display:block;margin:12px -20px -20px;-webkit-margin-start:-20px;-webkit-margin-end:-20px;border-radius:0 0 12px 12px}
  #qrStatus{display:none;align-items:center;gap:8px;margin:8px 0}
  #qrStatus.show{display:flex}
  
  /* Hiệu ứng đẹp cho QR */
  .qr{transition:all 0.3s ease;border:2px solid var(--border)}
  .qr:hover{transform:scale(1.05);border-color:var(--primary);box-shadow:0 4px 15px rgba(139,0,0,0.2)}
  
  /* Cải thiện toolbar */
  .toolbar{background:linear-gradient(135deg, #fff, #FFF5F5);padding:16px;border-radius:12px;border:1px solid var(--border);margin-bottom:16px;box-shadow:0 2px 10px rgba(139,0,0,0.05)}
  /* Tiêu đề trong toolbar chiếm trọn dòng để gạch chân kéo full khung */
  .toolbar h2{flex:1 0 100%; width:100%}
  /* Sắp xếp gọn 3 nút map để tận dụng ngang */
  .map-actions{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:6px}
  @media (max-width: 900px){ .map-actions{grid-template-columns:repeat(2,1fr)} }
  @media (max-width: 720px){ .map-actions{grid-template-columns:1fr} }
  /* Cho phép một ô trong lưới span toàn hàng để tận dụng khoảng trống hai bên */
  .col-span-2{grid-column:1 / -1}
  
  /* Cải thiện GitHub section */
  .gh-wrap{background:linear-gradient(135deg, #f8f9fa, #e9ecef);padding:16px;border-radius:12px;border:1px solid var(--border)}
  .gh-badge{background:linear-gradient(135deg, #fff, #f8f9fa);border:2px solid var(--primary-200)}

  /* Footer */
  .site-footer{margin-top:28px;background:var(--primary-600);color:#fff;box-shadow:0 -4px 20px rgba(102,0,0,0.2)}
  .site-footer .inner{max-width:1100px;margin:0 auto;padding:20px 16px;display:flex;gap:20px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .site-footer .copy{display:flex;flex-direction:row;gap:20px;align-items:center;flex:1}
  .site-footer .footer-logo{text-align:center;flex-shrink:0;display:flex;align-items:center}
  .site-footer .footer-logo-img{height:48px;width:48px;object-fit:contain;filter:drop-shadow(0 2px 6px rgba(0,0,0,0.3))}
  .site-footer .copyright-text{display:flex;flex-direction:column;gap:8px;flex:1;justify-content:center}
  .site-footer .line1{font-weight:600;letter-spacing:.3px;font-size:15px;line-height:1.3}
  .site-footer .line2{font-weight:700;text-transform:uppercase;color:#fff;letter-spacing:.8px;font-size:13px;line-height:1.2}
  .site-footer .contact{display:flex;flex-direction:column;gap:4px;text-align:right;min-width:280px}
  .site-footer .contact-title{font-weight:700;text-transform:uppercase;color:#fff;letter-spacing:.8px;font-size:12px;margin-bottom:4px;border-bottom:1px solid rgba(255,255,255,0.3);padding-bottom:4px}
  .site-footer .contact-info{font-size:13px;line-height:1.4;color:rgba(255,255,255,0.9)}
  .site-footer .contact-info strong{color:#fff;font-weight:600}
  .site-footer a{color:#fff;text-decoration:none;border-bottom:1px dotted rgba(255,255,255,.6);transition:all 0.2s ease}
  .site-footer a:hover{color:var(--accent);border-bottom-color:var(--accent)}

  /* Modal bản đồ */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;padding:16px;z-index:9999}
  .modal.hidden{display:none}
  .modal .content{width:min(900px,96vw);height:min(74vh,720px);background:#fff;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.2);display:flex;flex-direction:column;padding:12px}
  #map{flex:1;border-radius:12px;border:1px solid var(--border)}

  /* Khối GitHub */
  .gh-wrap{display:flex;gap:12px;align-items:flex-start}
  .gh-badge{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,#fff,#f7eef1);display:flex;align-items:center;justify-content:center;border:1px solid var(--border)}
  .gh-badge svg{width:30px;height:30px;fill:var(--primary)}
  .gh-body{flex:1}

  /* Mobile-first responsive design */
  @media (max-width: 1200px) {
    main { max-width: 95%; padding: 0 12px; }
    .site-footer .inner { max-width: 95%; }
  }
  
  @media (max-width: 900px) { 
    .grid.cols-3 { grid-template-columns: repeat(2, 1fr); }
    .grid.cols-2 { grid-template-columns: 1fr; }
    .actions { flex-direction: column; }
    .actions button { width: 100%; }
    .toolbar { flex-direction: column; gap: 12px; }
    .toolbar input[type="text"] { width: 100%; min-width: auto; }
    .toolbar .spacer { display: none; }
  }
  
  @media (max-width: 720px) {
    /* Header mobile optimization */
    header.hero { 
      flex-direction: column; 
      text-align: center; 
      padding: 16px 12px; 
      gap: 12px;
    }
    header.hero .ghost { display: none; }
    header.hero .title h1, header.hero .title h3 { white-space: normal; }
    header.hero .title h1 { font-size: 18px; line-height: 1.2; }
    header.hero .title h3 { font-size: 16px; line-height: 1.2; }
    header.hero .logo { height: 48px; width: 48px; }
    
    /* Main content mobile optimization */
    main { margin: 16px auto; padding: 0 12px; }
    .card { padding: 16px; margin-bottom: 16px; border-radius: 12px; }
    .card h2 { font-size: 18px; margin-bottom: 12px; }
    /* Toolbar title underline full-width & spacing */
    .toolbar h2 { width:100%; padding-bottom:6px; margin-bottom:10px; border-bottom:2px solid var(--accent); }
    
    /* Grid mobile optimization */
    .grid.cols-3 { grid-template-columns: 1fr; }
    .grid.cols-2 { grid-template-columns: 1fr; }
    
    /* Form elements mobile optimization */
    input[type="text"], input[type="password"], input[type="url"], textarea {
      padding: 12px 14px; 
      font-size: 16px; /* Prevents zoom on iOS */
      min-height: 44px; /* Better touch target */
    }
    
    /* Buttons mobile optimization */
    .actions { flex-direction: column; gap: 8px; }
    .actions button { 
      width: 100%; 
      font-size: 16px; 
      padding: 14px 16px; 
      min-height: 48px; /* Better touch target */
    }
    
    /* Toolbar mobile optimization */
    .toolbar { 
      position: sticky; 
      top: calc(env(safe-area-inset-top, 0px)); 
      background: #fff; 
      padding: 12px; 
      margin-bottom: 12px; 
      z-index: 50; 
      border-bottom: 2px solid var(--primary-200);
      flex-direction: column;
      gap: 12px;
    }
    .toolbar input[type="text"] { 
      width: 100%; 
      min-width: auto; 
      font-size: 16px;
    }
    .toolbar .spacer { display: none; }
    
    /* Table mobile optimization */
    .table-wrap { border-radius: 12px; }
    th.hide-sm, td.hide-sm { display: none; }
    th, td { 
      padding: 10px 8px; 
      font-size: 13px; 
      white-space: normal; 
    }
    
    /* QR code mobile optimization */
    .qr { width: 48px; height: 48px; }
    /* Giới hạn chiều cao địa chỉ theo chiều cao QR trên mobile */
    .addr-wrap{max-height:48px}
    
    /* Modal mobile optimization */
    .modal .content { 
      width: 100vw; 
      height: 100vh; 
      border-radius: 0; 
      padding: 10px; 
    }
    /* Tip wide khớp padding card ở mobile */
    .tip-wide{ margin-left:-16px; margin-right:-16px }
    
                   /* Footer mobile optimization */
      .site-footer .footer-logo { 
        margin-bottom: 8px; 
      }
      .site-footer .footer-logo-img { 
        height: 36px; 
        width: 36px; 
      }
     .site-footer .contact { 
       text-align: center; 
       min-width: auto; 
       margin: 16px 0; 
     }
    .site-footer .inner { 
      flex-direction: column; 
      text-align: center; 
      gap: 16px; 
      padding: 16px 12px;
    }
    .site-footer .contact-info { font-size: 12px; }
    
    /* GitHub section mobile optimization */
    .gh-wrap { flex-direction: column; gap: 16px; }
    .gh-badge { width: 48px; height: 48px; }
    .gh-badge svg { width: 24px; height: 24px; }
  }
  
  @media (max-width: 480px) {
    /* Extra small screens */
    header.hero { padding: 12px 8px; }
    header.hero .title h1 { font-size: 16px; }
    header.hero .title h3 { font-size: 14px; }
    
    main { padding: 0 8px; }
    .card { padding: 12px; }
    
    input[type="text"], input[type="password"], input[type="url"], textarea {
      padding: 10px 12px;
      font-size: 16px;
    }
    
    .actions button { 
      padding: 12px 14px; 
      font-size: 15px; 
    }
    .tip-wide{ margin-left:-12px; margin-right:-12px; font-size:13px; }
    
                   .site-footer .inner { padding: 16px 8px; }
      .site-footer .footer-logo-img { height: 32px; width: 32px; }
      .site-footer .contact-info { font-size: 11px; }
  }
  
  /* Touch-friendly improvements */
  @media (hover: none) and (pointer: coarse) {
    button, input, .qr, .gh-badge {
      -webkit-tap-highlight-color: rgba(139, 0, 0, 0.1);
    }
    
    .card:hover { transform: none; }
    .qr:hover { transform: none; }
    
    /* Larger touch targets for mobile */
    .gh-badge { min-width: 48px; min-height: 48px; }
    .qr { min-width: 48px; min-height: 48px; }
    
    /* Better touch scrolling */
    .table-wrap {
      -webkit-overflow-scrolling: touch;
      scroll-behavior: smooth;
    }
    
    /* Prevent text selection on buttons */
    button {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
  }
  
  /* Mobile-specific improvements */
  @media (max-width: 720px) {
    /* Better mobile spacing */
    .card + .card { margin-top: 16px; }
    
    /* Mobile-friendly table */
    .table-wrap {
      margin: 0 -12px;
      border-radius: 0;
      border-left: none;
      border-right: none;
    }
    
    /* Mobile-friendly buttons in actions */
    .actions .btn-secondary {
      background: #f8f9fa;
      border-color: var(--primary-200);
      color: var(--primary-600);
    }
    
    /* Mobile-friendly input focus */
    input:focus, textarea:focus {
      box-shadow: 0 0 0 3px rgba(139, 0, 0, 0.2);
      transform: none;
    }
    
    /* Mobile-friendly card shadows */
    .card {
      box-shadow: 0 2px 12px rgba(139, 0, 0, 0.1);
    }
    
    /* Mobile-friendly footer */
    .site-footer {
      margin-top: 20px;
    }
  }
  
  /* Mobile keyboard optimization */
  @media (max-height: 600px) and (orientation: landscape) {
    header.hero { padding: 8px 16px; }
    header.hero .title h1 { font-size: 14px; }
    header.hero .title h3 { font-size: 12px; }
    main { margin: 12px auto; }
    .card { padding: 12px; margin-bottom: 12px; }
  }
  
  /* Landscape mobile optimization */
  @media (max-width: 900px) and (orientation: landscape) {
    header.hero { flex-direction: row; padding: 12px 16px; }
    header.hero .title h1 { font-size: 16px; }
    header.hero .title h3 { font-size: 14px; }
    
    .grid.cols-3 { grid-template-columns: repeat(2, 1fr); }
    .actions { flex-direction: row; flex-wrap: wrap; }
    .actions button { flex: 1; min-width: 120px; }
  }
  
  /* Animation cho các card */
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(30px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  .card { animation: fadeInUp 0.6s ease-out; }
  
  /* Hiệu ứng loading cho button */
  .btn-loading { position: relative; color: transparent !important; }
  .btn-loading::after { content: ''; position: absolute; top: 50%; left: 50%; width: 20px; height: 20px; margin: -10px 0 0 -10px; border: 2px solid transparent; border-top: 2px solid currentColor; border-radius: 50%; animation: spin 1s linear infinite; }
  
  @keyframes spin { to { transform: rotate(360deg); } }
  
  /* Nhấp nháy cảnh báo đỏ cho bảng (đậm, rất dễ thấy) */
     .flash-danger{ animation: flashDanger 1.2s ease-in-out 3; }
   .table-wrap.flash-danger{ border-color: var(--danger) !important; }
   .card.flash-danger{ animation: flashDanger 1.2s ease-in-out 3; }
   
   .flash-success{ animation: flashSuccess 1.2s ease-in-out 3; }
   .card.flash-success{ animation: flashSuccess 1.2s ease-in-out 3; }
  @keyframes flashDanger{
    0%{
      background:#fff;
      box-shadow: none;
    }
    35%{
      background:#ffd6d6; /* đỏ nhạt rõ ràng */
      box-shadow: inset 0 0 0 4px rgba(220,20,60,.85), 0 0 16px rgba(220,20,60,.65);
    }
    70%{
      background:#fff0f0;
      box-shadow: inset 0 0 0 3px rgba(220,20,60,.75), 0 0 10px rgba(220,20,60,.55);
    }
    100%{
      background:#fff;
      box-shadow: none;
    }
  }
  /* Overlay nhấp nháy toàn màn hình để đảm bảo người dùng thấy rõ */
  .screen-flash{ position:fixed; inset:0; background:rgba(220,20,60,0); pointer-events:none; z-index:999999; animation: screenFlash 1.2s ease-in-out 3; }
  @keyframes screenFlash{
    0%{ background: rgba(220,20,60,0); }
    30%{ background: rgba(220,20,60,.35); }
    60%{ background: rgba(220,20,60,.15); }
    100%{ background: rgba(220,20,60,0); }
  }

  /* ===== Modal xác nhận xoá toàn bộ ===== */
  #clearModal .content{ width:min(480px,96vw); height:auto; padding:16px; }
  /* Generic confirm layout for modals */
  .modal .confirm-card{ display:flex; flex-direction:column; gap:12px; }
  .modal .confirm-card .actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:8px; }
  .blink-red{ animation: blinkRed 0.9s ease-in-out 2; }
  .blink-red-infinite{ animation: blinkRed 1.1s ease-in-out infinite; }
  @keyframes blinkRed{
    0%{ box-shadow:none; background:#fff; }
    50%{ box-shadow:0 0 0 3px rgba(220,20,60,.6); background:#FFECEC; }
    100%{ box-shadow:none; background:#fff; }
  }

  @keyframes flashSuccess {
    0% { background: #fff; box-shadow: none; }
    25% { background: #d4edda; box-shadow: inset 0 0 0 4px rgba(40, 167, 69, 0.85), 0 0 16px rgba(40, 167, 69, 0.65); }
    50% { background: #c3e6cb; box-shadow: inset 0 0 0 3px rgba(40, 167, 69, 0.75), 0 0 10px rgba(40, 167, 69, 0.55); }
    75% { background: #d4edda; box-shadow: inset 0 0 0 2px rgba(40, 167, 69, 0.65), 0 0 8px rgba(40, 167, 69, 0.45); }
    100% { background: #fff; box-shadow: none; }
  }
  </style>
  <!-- Leaflet CSS & vendor -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script defer src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script defer src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
</head>
<body>
  <header class="hero">
    <img class="logo" src="agribank-logo.png" alt="Agribank" onerror="this.style.display='none'"/>
    <div class="title">
      <h1>Ngân hàng Nông nghiệp và Phát triển Nông thôn</h1>
      <h3>CHI NHÁNH CẦN THƠ II</h3>
    </div>
    <div class="ghost" aria-hidden="true"></div>
  </header>

  <main>
        <!-- Form nhập địa chỉ -->
    <!-- ...existing code... -->
  <section class="card">
    <h2>Thêm địa chỉ</h2>
    <div class="grid cols-1">
      <div>
        <label for="officer">Cán bộ nhập *</label>
        <input id="officer" type="text" placeholder="VD: Nguyễn Văn B" />
      </div>
      <div>
        <label for="name">Tên địa điểm *</label>
        <input id="name" type="text" placeholder="VD: Hộ kinh doanh Nguyễn A" />
      </div>
      <div>
        <label for="address">Địa chỉ *</label>
        <input id="address" type="text" placeholder="VD: Số 08-10, Nam Kỳ Khởi Nghĩa, phường Ninh Kiều, TP Cần Thơ" />
      </div>
      <!-- Ẩn dòng nhập Link Google Maps, giữ lại các nút vị trí -->
            <!-- ...existing code... -->
      <div>
        <label for="mapsUrl">Hoặc dán link Google Maps *</label>
        <input id="mapsUrl" type="text" placeholder="https://maps.app.goo.gl/..." />
      </div>
      <!-- ...existing code... -->
      <div class="map-actions">
        <button id="btnUseCurrent" type="button" class="btn-secondary">📍 Vị trí hiện tại</button>
        <button id="btnPickOnMap" type="button" class="btn-secondary">🗺️ Chọn trên bản đồ</button>
        <button id="btnOpenMaps" type="button" class="btn-secondary">Google Maps</button>
      </div>
      <details>
        <summary>Thêm thông tin</summary>
        <div>
          <label for="phone">Số điện thoại</label>
          <input id="phone" type="text" placeholder="VD: 0987..." />
        </div>
        <div>
          <label for="branch">Chi nhánh</label>
          <input id="branch" type="text" placeholder="VD: CN Cần Thơ II" />
        </div>
        <div>
          <label for="customerCode">Mã KH</label>
          <input id="customerCode" type="text" placeholder="VD: 1890-XXXXXXXXX" />
        </div>
        <div>
          <label for="cccd">CCCD</label>
          <input id="cccd" type="text" placeholder="12 số" />
        </div>
        <div>
          <label for="note">Ghi chú</label>
          <input id="note" type="text" placeholder="VD: Nhà mặt tiền, giờ mở cửa, người liên hệ..." />
        </div>
      </details>
      <div class="actions" style="margin-top:16px;">
        <button class="btn-primary" id="btnCreate">Lưu thông tin</button>
        <button class="btn-secondary" id="btnQuickPrint">In QR nhanh</button>
        <button class="btn-secondary" id="btnReset">Xóa form</button>
      </div>
    </div>
    <span class="muted">* Bắt buộc</span>
    <div id="createStatus" class="muted" style="margin-top:6px; display:none; color:#0a0; font-weight:600;"></div>
  </section>  
    <!-- Đưa danh sách QR lên trên -->
  <section class="card">
    <h2>Danh sách đã nhập</h2>
    <div id="list"></div>
    <!-- Đưa toolbar xuống dưới list -->
         <div class="toolbar" style="margin-top:12px;">
       <input id="q" type="text" placeholder="Tìm theo tên/chi nhánh/mã KH/sđt/cán bộ" style="min-width:220px; padding:10px 10px; border:1px solid #ddd; border-radius:10px;" />
       <button class="btn-secondary" id="btnSyncGitHub" title="Đồng bộ dữ liệu từ GitHub">🔄 Đồng bộ GitHub</button>
       <button class="btn-secondary" id="btnSetToken" title="Thiết lập Token GitHub">Thiết lập Token</button>
       <button class="btn-secondary" id="btnZipSelected" title="Tải ZIP các QR đã chọn">ZIP QR (đã chọn)</button>
       <button class="btn-secondary" id="btnPrintA4" title="In nhiều tem trên 1 A4 cho các dòng đã chọn">In A4 (đã chọn)</button>
       <button class="btn-secondary" id="btnClearAll" title="Xóa toàn bộ trong trình duyệt (không ảnh hưởng GitHub)">Xóa toàn bộ</button>
     </div>
  </section>

    
  </main>

  <footer class="site-footer">
    <div class="inner">
      <div class="copy">
                 <div class="footer-logo">
           <a href="https://www.agribank.com.vn" target="_blank" rel="noopener">
             <img src="agribank-logo.png" alt="Agribank Logo" class="footer-logo-img">
           </a>
         </div>
        <div class="copyright-text">
          <div class="line1">Bản quyền © <span id="yearNow"></span> <b>AGRIBANK</b> — Ngân hàng Nông nghiệp và Phát triển Nông thôn Việt Nam</div>
          <div class="line2">CHI NHÁNH CẦN THƠ II • All rights reserved.</div>
        </div>
      </div>
      <div class="contact">
        <div class="contact-title">Liên hệ</div>
        <div class="contact-info">
          <strong>Nguyễn Thành Trung</strong><br>
          📱 <strong>Cellphone:</strong> 0947.86.86.82<br>
          📧 <strong>Email:</strong> trungnguyenthanh1@agribank.com.vn
        </div>
      </div>
             
    </div>
  </footer>

<script>
/* ========= Utilities ========= */
const LS_KEY='qr_maps_items_v3';
function uid(n=8){ return Math.random().toString(36).slice(2,2+n); }
function nowISO(){ return new Date().toISOString(); }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
function escapeHtml(s){ s=String(s||''); return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
function normalizePhone(v){ return String(v||'').replace(/[^0-9+]/g,''); }
function normalizeCCCD(v){ return String(v||'').replace(/[^0-9]/g,''); }
function mapsUrlFromAddress(a){ const q=encodeURIComponent(String(a||'').trim()); return `https://www.google.com/maps/search/?api=1&query=${q}`; }
function remember(k,v){ try{ localStorage.setItem(k,v) }catch(e){} }
function recall(k){ try{ return localStorage.getItem(k)||'' }catch(e){ return '' } }
async function sha256Hex(str){ const enc=new TextEncoder().encode(str); const buf=await crypto.subtle.digest('SHA-256',enc); return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join(''); }
function randomHex(bytes=8){ const a=new Uint8Array(bytes); crypto.getRandomValues(a); return Array.from(a).map(b=>b.toString(16).padStart(2,'0')).join(''); }

/* ========= QR loader ========= */
function loadScriptOnce(src){ return new Promise((res,rej)=>{ const s=document.createElement('script'); s.src=src; s.async=false; s.defer=true; s.onload=()=>res(); s.onerror=()=>rej(new Error('Failed '+src)); document.head.appendChild(s); }); }
let __qrReady=null;
async function ensureQRCode(maxWaitMs=15000){
  if (typeof window.QRCode!=='undefined' && window.QRCode.toCanvas) return;
  if (!__qrReady){
    const fallbacks=['https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js','https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js','https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.1/qrcode.min.js'];
    __qrReady=(async()=>{ for(const u of fallbacks){ try{ await loadScriptOnce(u); if(typeof window.QRCode!=='undefined') return; }catch(e){} } throw new Error('Không tải được QRCode'); })();
  }
  const banner=document.getElementById('qrStatus'); banner?.classList.add('show');
  const start=Date.now(); while(Date.now()-start<maxWaitMs){ try{ await __qrReady; }catch(e){} if(typeof window.QRCode!=='undefined'){ banner?.classList.remove('show'); return; } await sleep(2000); }
  banner?.classList.add('show'); throw new Error('QRCode chưa sẵn sàng.');
}

/* ========= QR Logo ========= */
const QR_LOGO={ enabled:true, src:'agribank-logo.png', sizeRatio:0.22, paddingRatio:0.06, rounded:10 };
let __logoImg=null;
async function loadLogo(){ if(!QR_LOGO.enabled) return null; if(__logoImg) return __logoImg;
  return new Promise((r)=>{ const img=new Image(); img.onload=()=>{__logoImg=img;r(img)}; img.onerror=()=>r(null); img.crossOrigin='anonymous'; img.src=QR_LOGO.src; });
}
function drawRoundedRect(ctx,x,y,w,h,r){
  const rr=Math.min(r,w/2,h/2);
  ctx.beginPath();
  ctx.moveTo(x+rr,y);
  ctx.arcTo(x+w,y,x+w,y+h,rr);
  ctx.arcTo(x+w,y+h,x,y,y+h,rr);
  ctx.arcTo(x,y+h,x,y,rr);
  ctx.arcTo(x,y,x+w,y,rr);
  ctx.closePath();
}

/* ========= Schema & state ========= */
const HEADERS=['id','code','name','address','mapsUrl','createdAt','note','phone','branch','cccd','customerCode','officer','pinSalt','pinHash'];
//function loadItems(){ try{ return JSON.parse(localStorage.getItem(LS_KEY))||[] }catch(e){ return [] } }
function loadItems(){ return []; } // không dùng nữa
//function saveItems(arr){ localStorage.setItem(LS_KEY, JSON.stringify(arr)); }
function saveItems(){ /* no-op: không lưu local */ }
function sheetToJsonStrict(ws){
  const arr=XLSX.utils.sheet_to_json(ws,{defval:'',raw:false});
  return arr.map(r=>({ id:r.id??'', code:r.code??'', name:r.name??'', address:r.address??'', mapsUrl:r.mapsUrl??'', createdAt:r.createdAt??'',
    note:r.note??'', phone:r.phone??'', branch:r.branch ?? r.group ?? '', cccd:r.cccd??'', customerCode:r.customerCode??'',
    officer:r.officer??'', pinSalt:r.pinSalt??'', pinHash:r.pinHash??'' }));
}
let items=[];//loadItems();
// migrate group -> branch
if(Array.isArray(items)){ let migrated=false; for(const it of items){ if(it && it.group && !it.branch){ it.branch=it.group; migrated=true; } } if(migrated) saveItems(items); }
let selectedIds=new Set();

/* ========= Auto-load từ GitHub ========= */
/*(async function autoLoadFromGitHub(){
  try{
    // Ưu tiên tải từ GitHub trước
    const githubSuccess = await loadFromGitHub();
    if(githubSuccess){
      console.log('Đã tải dữ liệu từ GitHub thành công');
      saveItems(items); // Lưu vào localStorage để backup
    } else {
      // Fallback: tải từ file local nếu GitHub thất bại
      try{
        const res=await fetch('data.xlsx?t='+Date.now(),{cache:'no-store'});
        if(res.ok){
          const buf=await res.arrayBuffer(); const wb=XLSX.read(buf,{type:'array'}); const ws=wb.Sheets[wb.SheetNames[0]];
          if(ws){
            const rows=sheetToJsonStrict(ws);
            const have=new Set(items.map(x=>x.id)); let added=0;
            for(const r of rows){ if(!have.has(r.id) && (r.name && (r.address||r.mapsUrl))){ items.push(r); added++; } }
            if(added){ items.sort((a,b)=> new Date(b.createdAt)-new Date(a.createdAt)); saveItems(items); }
          }
        }
      }catch(e){ console.log('Không thể tải từ file local:', e); }
    }
  }catch(e){
    console.error('Lỗi auto-load:', e);
  }
 
  renderTable();
})();*/

/* ========= CRUD ========= */
async function handleCreate(){
  const officer=document.getElementById('officer').value.trim();
  const pin='123123'; // Đặt mặc định
  const name=document.getElementById('name').value.trim();
  const branch=document.getElementById('branch').value.trim();
  const address=document.getElementById('address').value.trim();
  const mapsUrlInput=document.getElementById('mapsUrl').value.trim();
  const phone=normalizePhone(document.getElementById('phone').value.trim());
  const customerCode=document.getElementById('customerCode').value.trim();
  const cccd=normalizeCCCD(document.getElementById('cccd').value.trim());
  const note=document.getElementById('note').value.trim();
  if(!officer || !name || !address) return alert('Vui lòng nhập đầy đủ: Cán bộ nhập, Tên, Địa chỉ.');
  if(cccd && cccd.length!==12 && !confirm('CCCD không đủ 12 số. Vẫn lưu?')) return;
  const mapsUrl=mapsUrlInput || mapsUrlFromAddress(address);
  const createdAt=nowISO();
  let pinSalt='',pinHash='';
  if(pin){ pinSalt=randomHex(8); pinHash=await sha256Hex(pinSalt+pin); }
  const item={ id:uid(12), code:uid(8), name, address, mapsUrl, createdAt, note, phone, branch, cccd, customerCode, officer, pinSalt, pinHash };
  items.unshift(item); saveItems(items); renderTable();
  remember('lastOfficer', officer);
  const statusEl=document.getElementById('createStatus');
  if(statusEl){
    statusEl.style.display='none'; // Ẩn trước khi lưu
  }
  try{
    await saveToGitHub();
    if(statusEl){
      statusEl.textContent='Đã lưu thông tin thành công lên GitHub!';
      statusEl.style.display='block';
      statusEl.style.color='#0a0';
    }
    // Flash animation thành công
    const card = document.querySelector('main > section.card:first-of-type');
    if(card) card.classList.add('flash-success');
    setTimeout(() => card?.classList.remove('flash-success'), 1200);
    // Chỉ xóa form sau khi lưu GitHub thành công
    for(const id of ['name','branch','address','mapsUrl','phone','customerCode','cccd','note']) document.getElementById(id).value='';
    // Ẩn thông báo sau khi thành công (không ẩn khi lỗi)
    setTimeout(()=>{ const el=document.getElementById('createStatus'); if(el) el.style.display='none'; }, 3000);
  }catch(e){
    if(statusEl){
      statusEl.textContent='Lỗi lưu lên GitHub: ' + e.message;
      statusEl.style.display='block';
      statusEl.style.color='#c00';
    }
    console.error('GitHub save failed', e);
    // Khôi phục dữ liệu về trạng thái trước
    items = items.filter(x => x.id !== item.id);
    saveItems(items);
    renderTable();
  }
}
/* ========= ZIP & In A4 ========= */
function getSelectedItems(){ return items.filter(x=> selectedIds.has(x.id)); }
function dataURLtoBlob(dataURL){ const parts=dataURL.split(','); const bstr=atob(parts[1]); const u8=new Uint8Array(bstr.length); for(let i=0;i<bstr.length;i++) u8[i]=bstr.charCodeAt(i); return new Blob([u8],{type:'image/png'}); }
async function zipSelected(){
  const sel=getSelectedItems(); if(!sel.length) return alert('Hãy chọn ít nhất 1 dòng.');
  const zip=new JSZip();
  for(const it of sel){
    const dataUrl=await makeQRDataUrl(it.mapsUrl,1024);
    const blob=dataURLtoBlob(dataUrl);
    const fname=`QR_${it.code}_${(it.name||'').replace(/\s+/g,'_').slice(0,50)}.png`;
    zip.file(fname,blob);
  }
  const out=await zip.generateAsync({type:'blob'});
  const a=document.createElement('a'); const url=URL.createObjectURL(out);
  a.href=url; a.download='qr_da_chon.zip'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),1500);
}
async function printA4Selected(){
  const sel=getSelectedItems(); if(!sel.length) return alert('Hãy chọn ít nhất 1 dòng.');
  const data=[]; for(const it of sel){ data.push({ it, qr:await makeQRDataUrl(it.mapsUrl,1024) }); }
  const win=window.open('','_blank');
  const tiles=data.map(d=>`
    <div class="tile">
      <img src="${d.qr}" />
      <div class="t">
        <div class="n">${escapeHtml(d.it.name)}</div>
        <div class="a">${escapeHtml(d.it.address||'')}</div>
        <div class="m">${escapeHtml(d.it.mapsUrl)}</div>
      </div>
    </div>`).join('');
  win.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>In tem A4</title>
<style>
  @page{size:A4;margin:8mm}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0}
  .actions{position:fixed;top:8px;right:8px}
  @media print{.actions{display:none}}
  .sheet{display:grid;grid-template-columns:repeat(3,1fr);gap:6mm;padding:8mm}
  .tile{border:1px dashed #ddd;padding:3mm;display:flex;gap:3mm;align-items:center}
  .tile img{width:28mm;height:28mm;object-fit:contain;border:1px solid #eee;border-radius:4mm;background:#fff}
  .t{font-size:3.2mm}.t .n{font-weight:700;margin-bottom:1mm}
  .t .m{font-family:ui-monospace,Menlo,Consolas,monospace;word-break:break-all;color:#555;font-size:3mm}
</style></head>
<body><div class="actions"><button onclick="window.print()">In</button></div>
<div class="sheet">${tiles}</div></body></html>`);
  win.document.close();
}

/* ========= QR helpers ========= */
async function makeQRDataUrl(text, size = 512){
  try{ await ensureQRCode(); }catch(e){}
  let lastErr = null;

  for (let i=0; i<3; i++){
    try{
      if (typeof QRCode === 'undefined') throw new Error('QRCode chưa sẵn sàng');

      const canvas = document.createElement('canvas');

      // Viền trắng dày hơn để chịu được bo/scale của trình duyệt
      await new Promise((resolve, reject)=>{
        QRCode.toCanvas(
          canvas, text,
          { width: size, margin: 4, errorCorrectionLevel: 'H' },
          err => err ? reject(err) : resolve()
        );
      });

      // ---- Logo: chỉ chèn khi ảnh đủ lớn (in/tải), KHÔNG chèn cho thumbnail ----
      const useLogo = QR_LOGO.enabled && size >= 300;
      if (useLogo){
        const img = await loadLogo();
        if (img){
          const ctx = canvas.getContext('2d');
          const logoSize = Math.round(size * 0.18);   // nhỏ hơn để an toàn
          const pad      = Math.round(size * 0.04);
          const dx = Math.round((size - logoSize)/2);
          const dy = Math.round((size - logoSize)/2);

          // bo nhẹ nền logo (vẽ đúng tâm, không đè góc finder)
          ctx.save();
          ctx.fillStyle = '#fff';
          // Dùng đúng tên roundRect như phần gọi
function roundRect(ctx, x, y, w, h, r){
  const rr = Math.min(r, w/2, h/2);
  ctx.beginPath();
  ctx.moveTo(x+rr, y);
  ctx.arcTo(x+w, y, x+w, y+h, rr);
  ctx.arcTo(x+w, y+h, x, y+h, rr);
  ctx.arcTo(x, y+h, x, y, rr);
  ctx.arcTo(x, y, x+w, y, rr);
  ctx.closePath();
}
          ctx.fill();
          ctx.restore();

          ctx.drawImage(img, dx, dy, logoSize, logoSize);
        }
      }
      // ------------------------------------------------------------------------

      return canvas.toDataURL('image/png');
    }catch(err){
      lastErr = err;
      await sleep(800);
    }
  }
  throw lastErr || new Error('Không tạo được QR');
}
async function downloadQR(url,filename){
  try{ const a=document.createElement('a'); a.href=await makeQRDataUrl(url,1024); a.download=filename||'qr.png'; a.click(); }
  catch(e){ alert('Không tạo được QR.'); }
}
async function openPrint(code, mode = 'full'){
  const it = items.find(x => x.code === code);
  if (!it) return;

  // Mở cửa sổ ngay khi click (tránh chặn pop-up)
  const win = window.open('', '_blank');
  if (!win) { alert('Trình duyệt đang chặn pop-up. Hãy cho phép mở cửa sổ mới.'); return; }
  // Tạm nội dung "đang tạo"
  win.document.write('<!doctype html><meta charset="utf-8"><title>Đang tạo QR...</title><body style="font-family:system-ui;padding:20px">Đang tạo QR...</body>');
  win.document.close();

  let qr = '';
  try { qr = await makeQRDataUrl(it.mapsUrl, 1024); }
  catch (e) { win.close(); alert('Không tạo được QR (mạng chậm).'); return; }

  // Ghi nội dung cuối
  if (mode === 'qr'){
    win.document.open();
    win.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>In QR – ${escapeHtml(it.name)}</title>
<style>@page{size:A7;margin:8mm}body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;display:flex;justify-content:center;align-items:center;height:100vh}
img{width:65mm;height:65mm;object-fit:contain;border:1px solid #eee;border-radius:12px}.actions{position:fixed;top:10px;right:10px}@media print{.actions{display:none}}</style></head>
<body><div class="actions"><button onclick="window.print()">In</button></div><img src="${qr}" alt="QR ${escapeHtml(it.name)}"/></body></html>`);
    win.document.close();
    return;
  }

  win.document.open();
  win.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>In nhãn – ${escapeHtml(it.name)}</title>
<style>@page{size:A7;margin:6mm}body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0}
.label{display:flex;gap:12px;align-items:center;padding:10px}.qr{width:180px;height:180px;object-fit:contain;border:1px solid #eee;border-radius:12px}
h1{font-size:20px;margin:0 0 4px}.addr{color:#444}.meta{font-size:12px;color:#555;margin-top:6px}
.code{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;color:#666;font-size:12px;margin-top:4px}.actions{position:fixed;top:10px;right:10px}
@media print{.actions{display:none}}</style></head>
<body><div class="actions"><button onclick="window.print()">In</button></div>
<div class="label"><img class="qr" src="${qr}" alt="QR ${escapeHtml(it.name)}"/><div>
<h1>${escapeHtml(it.name)}</h1>
<div class="addr">${escapeHtml(it.address||'')}</div>
<div class="meta">Cán bộ: ${escapeHtml(it.officer||'')} • Chi nhánh: ${escapeHtml(it.branch||'')}</div>
<div class="meta">Mã KH: ${escapeHtml(it.customerCode||'')} • SĐT: ${escapeHtml(it.phone||'')}</div>
<div class="meta">CCCD: ${escapeHtml(it.cccd||'')}</div>
<div class="meta">Ghi chú: ${escapeHtml(it.note||'')}</div>
<div class="code">Maps: ${escapeHtml(it.mapsUrl)}</div>
</div></div></body></html>`);
  win.document.close();
}


/* ========= Map helpers ========= */
function gmLinkFromLatLng(lat,lng){ return `https://www.google.com/maps/search/?api=1&query=${lat.toFixed(6)},${lng.toFixed(6)}`; }
function openMapsTab(){ const addr=document.getElementById('address').value.trim(); const url=addr?`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addr)}`:'https://maps.google.com/'; window.open(url,'_blank'); }

function useCurrentPosition(){
  if (!('geolocation' in navigator)) return alert('Trình duyệt không hỗ trợ định vị.');
  navigator.geolocation.getCurrentPosition(
    async pos => {
      const { latitude: lat, longitude: lng } = pos.coords || {};
      document.getElementById('mapsUrl').value = gmLinkFromLatLng(lat, lng);
      // Tự động điền địa chỉ khi chọn vị trí hiện tại
      try{
        const addr = await reverseGeocode(lat, lng);
        const el = document.getElementById('address');
        if (addr) el.value = addr;
      }catch{}
    },
    () => alert('Không lấy được vị trí hiện tại.'),
    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
  );
}

let map, marker, picked;
function openPickOnMap(){
  const modal=document.getElementById('mapModal');
  modal.classList.remove('hidden');
  document.body.classList.add('no-scroll');

  if (!map) {
    map = L.map('map', { zoomControl: true });
    map.setView([21.0278, 105.8342], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);
    map.on('click', (e) => setPicked(e.latlng));
  }

  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const ll = [pos.coords.latitude, pos.coords.longitude];
        map.setView(ll, 16);
        setPicked({ lat: ll[0], lng: ll[1] });
        setTimeout(() => map.invalidateSize(), 60);
      },
      () => setTimeout(() => map.invalidateSize(), 60),
      { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
    );
  } else {
    setTimeout(() => map.invalidateSize(), 60);
  }
}
function closePickOnMap(){
  document.getElementById('mapModal').classList.add('hidden');
  document.body.classList.remove('no-scroll');
}
function setPicked(latlng){
  picked = latlng;
  if (!marker) { marker = L.marker(latlng).addTo(map); } else { marker.setLatLng(latlng); }
  const info=document.getElementById('pickedInfo');
  if (info) info.textContent = `Đã chọn: ${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`;
}
async function reverseGeocode(lat,lng){ const res=await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`,{headers:{'Accept':'application/json'}}); if(!res.ok) return ''; const j=await res.json(); return j.display_name||''; }
async function searchPlaceByText(q){ const res=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1`,{headers:{'Accept':'application/json'}}); if(!res.ok) return null; const arr=await res.json(); if(!arr||!arr[0]) return null; return {lat:parseFloat(arr[0].lat),lng:parseFloat(arr[0].lon),label:arr[0].display_name}; }

/* ========= Render ========= */
function renderTable(){
  const wrap=document.getElementById('list'); if(!wrap){ console.warn('#list missing'); return; }
  let arr=items.slice(); const q=(document.getElementById('q').value||'').trim().toLowerCase();
  if(q){ arr=arr.filter(x=>[x.name,x.branch,x.customerCode,x.phone,x.officer].some(v=>String(v||'').toLowerCase().includes(q))); }
  if(!arr.length){ wrap.innerHTML='<div class="empty">Chưa có mục nào</div>'; return; }
  wrap.innerHTML=`
    <div class="table-wrap">
    <table>
      <thead><tr>
        <th><input type="checkbox" id="selAll" title="Chọn/Bỏ chọn tất cả"></th>
        <th>QR</th>
        <th class="link-col">Link Maps</th>
        <th>Tên</th>
        <th class="addr-col hide-sm">Địa chỉ</th>
        <th class="hide-sm">Cán bộ</th>
        <th>Chi nhánh</th>
        <th>Mã KH</th>
        <th class="hide-sm">SĐT</th>
        <th class="hide-sm">CCCD</th>
        <th class="hide-sm">Mã</th>
        <th>Hành động</th>
      </tr></thead>
      <tbody>
        ${arr.map(x=>`
          <tr>
            <td><input type="checkbox" class="sel" data-id="${x.id}" ${selectedIds.has(x.id)?'checked':''}></td>
            <td><img class="qr" src="" data-code="${x.code}" /></td>
            <td class="link-col"><a class="code" href="${x.mapsUrl}" target="_blank">Mở</a></td>
            <td>${escapeHtml(x.name)}<div class="muted">${escapeHtml(x.note||'')}</div></td>
            <td class="addr-col hide-sm"><div class="addr-wrap">${escapeHtml(x.address||'')}</div></td>
            <td class="hide-sm">${escapeHtml(x.officer||'')}</td>
            <td>${escapeHtml(x.branch||'')}</td>
            <td class="code">${escapeHtml(x.customerCode||'')}</td>
            <td class="hide-sm">${escapeHtml(x.phone||'')}</td>
            <td class="hide-sm">${escapeHtml(x.cccd||'')}</td>
            <td class="code hide-sm">
              <span class="masked" data-id="${x.id}">********</span>
              <button class="toggle-code" data-id="${x.id}" title="Xem mã" style="margin-left:6px;padding:2px 6px;border:1px solid #ddd;border-radius:6px;background:#fff;cursor:pointer">👁</button>
            </td>
            <td class="inline-btns">
              <button data-act="print-qr" data-code="${x.code}">In QR</button>
              <span class="sep hide-sm">|</span>
              <button data-act="print-full" data-code="${x.code}">In đầy đủ</button>
              <span class="sep hide-sm">|</span>
              <button class="hide-sm" data-act="download" data-url="${escapeHtml(x.mapsUrl)}" data-code="${x.code}">Tải QR</button>
              <span class="sep hide-sm">|</span>
              <button class="hide-sm" data-act="edit" data-id="${x.id}">Sửa</button>
              <span class="sep hide-sm">|</span>
              <button class="btn-danger" data-act="delete" data-id="${x.id}">Xóa</button>
            </td>
          </tr>`).join('')}
      </tbody>
    </table>
    </div>`;
  const imgs=wrap.querySelectorAll('img.qr');
  imgs.forEach(async img=>{ const code=img.getAttribute('data-code'); const it=items.find(x=>x.code===code); if(!it) return; try{ img.src=await makeQRDataUrl(it.mapsUrl,320); }catch{ setTimeout(async()=>{ try{ img.src=await makeQRDataUrl(it.mapsUrl,256);}catch{} },1200); } });
  const selAll=document.getElementById('selAll'); selAll.addEventListener('change',()=>{ if(selAll.checked){ arr.forEach(x=>selectedIds.add(x.id)); } else { arr.forEach(x=>selectedIds.delete(x.id)); } renderTable(); });
  wrap.querySelectorAll('input.sel').forEach(cb=> cb.addEventListener('change',(e)=>{ const id=e.target.getAttribute('data-id'); if(e.target.checked) selectedIds.add(id); else selectedIds.delete(id); }));
  wrap.querySelectorAll('[data-act]').forEach(btn=> btn.addEventListener('click', async (e)=>{
    const act=e.currentTarget.getAttribute('data-act');
    if(act==='print-qr') return openPrint(e.currentTarget.getAttribute('data-code'),'qr');
    if(act==='print-full') return openPrint(e.currentTarget.getAttribute('data-code'),'full');
    if(act==='download') return downloadQR(e.currentTarget.getAttribute('data-url'),'qr_'+e.currentTarget.getAttribute('data-code')+'.png');
    if(act==='edit') return editItem(e.currentTarget.getAttribute('data-id'));
    if(act==='delete') return delItem(e.currentTarget.getAttribute('data-id'));
  }));

  // Toggle show code via modal with password
 // ...existing code...
// ...existing code...
wrap.querySelectorAll('button.toggle-code').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const id=btn.getAttribute('data-id');
    const row=items.find(x=>x.id===id);
    if(!row) return;
    // Modal xác nhận nhỏ, có nhấp nháy đỏ
    const modal=document.createElement('div');
    modal.className='modal';
    modal.innerHTML=`
      <div class="content blink-red-infinite" style="width:min(480px,96vw);height:auto;padding:16px;">
        <div class="confirm-card">
          <h3 style="margin:0">Xem mã?</h3>
          <div class="muted">Nhập mã xác nhận để xem mã này</div>
          <input id="viewCode" type="password" placeholder="Nhập mã..." style="padding:12px 14px;border:1px solid #ddd;border-radius:10px;">
          <div class="actions">
            <button id="viewCancel" class="btn-secondary">Hủy</button>
            <button id="viewOk" class="btn-primary">Xem</button>
          </div>
        </div>
      </div>`;
    document.body.appendChild(modal);
    const close=()=> modal.remove();
    modal.addEventListener('click',(e)=>{ if(e.target===modal) close(); });
    modal.querySelector('#viewCancel')?.addEventListener('click', close);
    modal.querySelector('#viewOk')?.addEventListener('click', ()=>{
      const code=(document.getElementById('viewCode')?.value||'').trim();
      if(code!=='Adme@nPC'){
        const box=modal.querySelector('.content');
        box?.classList.add('blink-red');
        setTimeout(()=> box?.classList.remove('blink-red'), 900);
        return;
      }
      const span=wrap.querySelector(`span.masked[data-id="${id}"]`);
      if(span){ span.textContent=row.code; }
      close();
    });
  });
});
// ...existing code...
}

/* ========= Delete / Edit ========= */
// ...existing code...
async function delItem(id){
  const it=items.find(x=>x.id===id); if(!it) return;
  const codeInput=prompt('Nhập Mã (code) của mục này để xác nhận xóa:')||'';
  if(String(codeInput).trim()!==String(it.code).trim()) return alert('Mã không đúng.');
  if(!confirm('Xóa mục này?')) return;
  
  // Lưu trạng thái trước khi xóa
  const originalItems = [...items];
  items=items.filter(x=>x.id!==id); 
  saveItems(items); 
  renderTable();
  
  try { 
    await saveToGitHub(); 
    showStatus('Đã xóa thành công lên GitHub!', 'success');
  } catch(e) { 
    console.error('GitHub save failed', e);
    // Khôi phục dữ liệu về trạng thái trước
    items = originalItems;
    saveItems(items);
    renderTable();
    showStatus('Lỗi xóa lên GitHub: ' + e.message, 'error');
  }
}
async function editItem(id){
  const it=items.find(x=>x.id===id); if(!it) return;
  const codeInput=prompt('Nhập Mã (code) của mục này để chỉnh sửa:')||'';
  if(String(codeInput).trim()!==String(it.code).trim()) return alert('Mã không đúng.');
  const name=prompt('Tên địa điểm:', it.name) ?? it.name;
  const address=prompt('Địa chỉ:', it.address||'') ?? it.address;
  const mapsUrl=prompt('Link Maps:', it.mapsUrl||'') ?? it.mapsUrl;
  const note=prompt('Ghi chú:', it.note||'') ?? it.note;
  const phone=prompt('SĐT:', it.phone||'') ?? it.phone;
  const branch=prompt('Chi nhánh:', it.branch||'') ?? it.branch;
  const cccd=prompt('CCCD:', it.cccd||'') ?? it.cccd;
  const customerCode=prompt('Mã KH:', it.customerCode||'') ?? it.customerCode;
  
  // Lưu trạng thái trước khi sửa
  const originalItems = [...items];
  Object.assign(it,{ name,address,mapsUrl,note,phone,branch,cccd,customerCode }); 
  saveItems(items); 
  renderTable();
  
  try { 
    await saveToGitHub(); 
    showStatus('Đã sửa thành công lên GitHub!', 'success');
  } catch(e) { 
    console.error('GitHub save failed', e);
    // Khôi phục dữ liệu về trạng thái trước
    items = originalItems;
    saveItems(items);
    renderTable();
    showStatus('Lỗi sửa lên GitHub: ' + e.message, 'error');
  }
}

/* ========= Quick Print ========= */
document.getElementById('btnQuickPrint')?.addEventListener('click', async ()=>{
  const officer=document.getElementById('officer').value.trim();
  const name=document.getElementById('name').value.trim();
  const address=document.getElementById('address').value.trim();
  const mapsUrlInput=document.getElementById('mapsUrl').value.trim();
  const phone=normalizePhone(document.getElementById('phone').value.trim());
  const branch=document.getElementById('branch').value.trim();
  const customerCode=document.getElementById('customerCode').value.trim();
  const cccd=normalizeCCCD(document.getElementById('cccd').value.trim());
  const note=document.getElementById('note').value.trim();
  const mapsUrl=mapsUrlInput || (address?mapsUrlFromAddress(address):'');
  if(!name || !mapsUrl){ return alert('Để In QR nhanh: cần ít nhất Tên và (Địa chỉ hoặc Link Maps).'); }
  const it={ name,address,mapsUrl,officer,branch,customerCode,cccd,phone,note };
  let qr=''; try{ qr=await makeQRDataUrl(mapsUrl,1024); }catch(e){ alert('Không tạo được QR (mạng chậm).'); return; }
  const win=window.open('','_blank');
  win.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>In nhãn nhanh – ${escapeHtml(it.name)}</title><style>@page{size:A7;margin:6mm}body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0}.label{display:flex;gap:12px;align-items:center;padding:10px}.qr{width:180px;height:180px;object-fit:contain;border:1px solid #eee;border-radius:12px}h1{font-size:20px;margin:0 0 4px}.addr{color:#444}.meta{font-size:12px;color:#555;margin-top:6px}.code{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;color:#666;font-size:12px;margin-top:4px}.actions{position:fixed;top:10px;right:10px}@media print{.actions{display:none}}</style></head><body><div class="actions"><button onclick="window.print()">In</button></div><div class="label"><img class="qr" src="${qr}" alt="QR ${escapeHtml(it.name)}"/><div><h1>${escapeHtml(it.name)}</h1><div class="addr">${escapeHtml(it.address||'')}</div><div class="meta">Cán bộ: ${escapeHtml(it.officer||'')} • Chi nhánh: ${escapeHtml(it.branch||'')}</div><div class="meta">Mã KH: ${escapeHtml(it.customerCode||'')} • SĐT: ${escapeHtml(it.phone||'')}</div><div class="meta">CCCD: ${escapeHtml(it.cccd||'')}</div><div class="meta">Ghi chú: ${escapeHtml(it.note||'')}</div><div class="code">Maps: ${escapeHtml(it.mapsUrl)}</div></div></div></body></html>`); win.document.close();
});

/* ========= GitHub Integration ========= */
const GH_DEFAULT={ owner:'tvnghp', repo:'QR', branch:'main', path:'data.xlsx' };
/* ========= GitHub-only Boot ========= */
function renderLoading(msg){
  const wrap=document.getElementById('list');
  if(!wrap) return;
  wrap.innerHTML = `<div class="table-wrap"><div class="empty">${escapeHtml(msg)}</div></div>`;
}
function renderError(msg){
  const wrap=document.getElementById('list');
  if(!wrap) return;
  wrap.innerHTML = `<div class="table-wrap flash-danger"><div class="empty">${escapeHtml(msg)}</div></div>`;
}

/*async function githubBoot(){
  renderLoading('Đang tải dữ liệu từ GitHub…');

  const token = getGhToken(); // dùng hàm bạn đã có ở modal token
  if(!token){
    renderError('Chưa thiết lập GitHub Token. Bấm “Thiết lập Token” để nhập PAT.');
    // mở sẵn modal cho tiện
    if(typeof openTokenModal==='function') openTokenModal();
    return;
  }

  try{
    const ok = await loadFromGitHub(); // CHỈ tải từ GitHub
    if(!ok){
      renderError('Không thể tải dữ liệu từ GitHub. Kiểm tra PAT/quyền repo rồi thử lại.');
      if(typeof openTokenModal==='function') openTokenModal();
      return;
    }
    // Thành công → hiển thị bảng + (tuỳ chọn) cache sang localStorage
    saveItems(items);
    renderTable();
    showStatus('Đã nạp dữ liệu từ GitHub', 'success');
  }catch(e){
    console.error(e);
    renderError('Lỗi tải từ GitHub. Mở “Thiết lập Token” để kiểm tra lại.');
    if(typeof openTokenModal==='function') openTokenModal();
  }
}*/
/* ========= Boot: ưu tiên GitHub, fallback data.xlsx (không LocalStorage) ========= */
function renderLoading(msg){
  const wrap=document.getElementById('list');
  if(wrap) wrap.innerHTML = `<div class="table-wrap"><div class="empty">${escapeHtml(msg)}</div></div>`;
}
function renderError(msg){
  const wrap=document.getElementById('list');
  if(wrap) wrap.innerHTML = `<div class="table-wrap flash-danger"><div class="empty">${escapeHtml(msg)}</div></div>`;
}

async function githubBoot(){
  renderLoading('Đang tải dữ liệu từ GitHub…');

  // Lấy PAT từ modal/token helper của bạn (không đụng LocalStorage nếu bạn đã no-op)
  const token = (typeof getGhToken==='function') ? getGhToken() : (window.GH_TOKEN || '');

  let ok = false;
  if(token){                       // Có token thì thử GitHub trước
    try { ok = await loadFromGitHub(); } catch { ok = false; }
  }

  if(!ok){
    renderLoading('Không tải được từ GitHub. Đang dùng dữ liệu cục bộ (data.xlsx)…');
    const okLocal = await loadFromLocalXlsx();
    if(okLocal){
      renderTable();
      showStatus('Đã nạp từ data.xlsx (fallback).', 'info');
    }else{
      renderError('Không tải được dữ liệu: GitHub lỗi và cũng không tìm thấy data.xlsx.');
    }
    return;
  }

  // Thành công từ GitHub
  renderTable();
  showStatus('Đã nạp dữ liệu từ GitHub', 'success');
}


/* Gọi boot khi DOM sẵn sàng (sau khi đã định nghĩa GH_DEFAULT & loadFromGitHub) */
addEventListener('DOMContentLoaded', () => {
  // GỌI SỚM NHẤT TRONG HANDLER
  githubBoot();
});

let ghShaCache=null;
  /* ==== GitHub Token (Base64) ====
   Lưu ý: Base64 chỉ là mã hoá/obfuscation nhẹ, KHÔNG bảo mật tuyệt đối.
   Cách dùng:
     - Option 1 (đề xuất): Lưu token vào localStorage (được mã hoá base64):
          localStorage.setItem('gh_token_b64', btoa('ghp_xxx_your_token_here'));
     - Option 2: Nhúng trực tiếp token (base64) vào file này bằng cách điền vào GH_TOKEN_B64_FILE.
*/
// ====== Token (base64) – LƯU Ý: không commit PAT thật vào repo public ======
const GH_TOKEN_B64_FILE = 'Z2l0aHViX3BhdF8xMUFZS0lFTlkwbXcwalJNbzg3cThOX3E5a2pKa0pjZERhTzIycGJJc2NEVExOdGhKcjJBMFppaVhhMkwzZ1RmSEtIUEgyNUlGWGFvMWVzejNy'; // có thể để trống ''

function getGhTokenB64(){
  try { return localStorage.getItem('gh_token_b64') || GH_TOKEN_B64_FILE || ''; }
  catch { return GH_TOKEN_B64_FILE || ''; }
}
function getGhToken(){
  const b64 = getGhTokenB64();
  try { return b64 ? atob(b64) : ''; } catch { return ''; }
}
function maskToken(t){
  if(!t) return '(chưa có)';
  if(t.length <= 10) return t[0] + '***' + t.slice(-2);
  return t.slice(0,6) + '...' + t.slice(-4);
}


// Helper để set token dạng text rồi tự lưu base64 vào localStorage (gọi trong console nếu cần)
function setGithubTokenPlain(tokenText){
  try {
    if (!tokenText || !tokenText.trim()) throw new Error('Token rỗng');
    localStorage.setItem('gh_token_b64', btoa(tokenText.trim()));
    console.log('Đã lưu token (base64) vào localStorage: gh_token_b64');
  } catch (e) {
    console.error('Không thể lưu token:', e);
    alert('Không thể lưu token: ' + e.message);
  }
}

  const GH_COMMIT_MESSAGE='Cập nhật data.xlsx từ công cụ QR';

// Tải dữ liệu trực tiếp từ GitHub
async function loadFromGitHub() {
  try {
    const url = `https://api.github.com/repos/${GH_DEFAULT.owner}/${GH_DEFAULT.repo}/contents/${encodeURIComponent(GH_DEFAULT.path)}?ref=${encodeURIComponent(GH_DEFAULT.branch)}`;
    const response = await fetch(url, {
      headers: {
        'Accept': 'application/vnd.github+json',
        'Authorization': 'token ' + getGhToken()
      }
    });
    
    if (!response.ok) {
      throw new Error(`GitHub API ${response.status}: ${await response.text()}`);
    }
    
    const fileData = await response.json();
    ghShaCache = fileData.sha || null;
    
    // Tải nội dung file Excel
    const contentResponse = await fetch(fileData.download_url);
    if (!contentResponse.ok) {
      throw new Error('Không tải được nội dung file');
    }
    
    const arrayBuffer = await contentResponse.arrayBuffer();
    const workbook = XLSX.read(arrayBuffer, { type: 'array' });
    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
    
    if (worksheet) {
      const rows = sheetToJsonStrict(worksheet);
      items = rows.filter(row => row.name && (row.address || row.mapsUrl));
      items.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
      console.log(`Đã tải ${items.length} mục từ GitHub`);
      return true;
    }
  } catch (error) {
    console.error('Lỗi tải từ GitHub:', error);
    return false;
  }
  return false;
}
// Fallback: nạp từ file data.xlsx nằm cạnh index.html (không dùng localStorage)
async function loadFromLocalXlsx(){
  try{
    const res = await fetch('data.xlsx?t='+Date.now(), { cache: 'no-store' });
    if(!res.ok) throw new Error('HTTP '+res.status);
    const buf = await res.arrayBuffer();
    const wb  = XLSX.read(buf, { type: 'array' });
    const ws  = wb.Sheets[wb.SheetNames[0]];
    if(!ws) throw new Error('Không tìm thấy sheet đầu tiên');

    const rows = sheetToJsonStrict(ws);
    items = rows.filter(r => r.name && (r.address || r.mapsUrl));
    items.sort((a,b)=> new Date(b.createdAt||0) - new Date(a.createdAt||0));
    return true;
  }catch(e){
    console.error('Lỗi fallback local:', e);
    return false;
  }
}

// Lưu dữ liệu lên GitHub
async function saveToGitHub() {
  // Helper: lấy SHA hiện tại của file (nếu tồn tại)
  async function fetchCurrentSha(){
    const getUrl = `https://api.github.com/repos/${GH_DEFAULT.owner}/${GH_DEFAULT.repo}/contents/${encodeURIComponent(GH_DEFAULT.path)}?ref=${encodeURIComponent(GH_DEFAULT.branch)}`;
    const res = await fetch(getUrl, { headers: { 'Accept':'application/vnd.github+json', 'Authorization':'token ' + getGhToken } });
    if (res.status === 404) return null; // file chưa tồn tại
    if (!res.ok) throw new Error(`GitHub API ${res.status}: ${await res.text()}`);
    const j = await res.json();
    return j && j.sha ? j.sha : null;
  }

  // Tạo workbook Excel mới
  const workbook = new ExcelJS.Workbook();
  const worksheet = workbook.addWorksheet('locations');

  // Định nghĩa cột
  const columns = ['id', 'code', 'name', 'address', 'mapsUrl', 'createdAt', 'note', 'phone', 'branch', 'cccd', 'customerCode', 'officer', 'pinSalt', 'pinHash'];
  worksheet.columns = columns.map(col => ({
    header: col,
    key: col,
    width: col === 'mapsUrl' ? 60 : (col === 'address' ? 40 : (col === 'name' ? 30 : 18))
  }));

  // Thêm dữ liệu
  worksheet.addRows(items);
  worksheet.views = [{ state: 'frozen', ySplit: 1 }];

  // Chuyển thành buffer
  const buffer = await workbook.xlsx.writeBuffer();
  const base64 = btoa(String.fromCharCode(...new Uint8Array(buffer)));

  // Chuẩn bị body và SHA
  let currentSha = ghShaCache;
  if (!currentSha) {
    try { currentSha = await fetchCurrentSha(); } catch(e) { console.warn('Không lấy được SHA hiện tại:', e.message); }
  }
  let body = { message: GH_COMMIT_MESSAGE, content: base64, branch: GH_DEFAULT.branch };
  if (currentSha) body.sha = currentSha;

  const url = `https://api.github.com/repos/${GH_DEFAULT.owner}/${GH_DEFAULT.repo}/contents/${encodeURIComponent(GH_DEFAULT.path)}`;

  async function putOnce(payload){
    const res = await fetch(url, {
      method: 'PUT',
      headers: {
        'Accept': 'application/vnd.github+json',
        'Authorization': 'token ' + getGhToken(),
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(payload)
    });
    return res;
  }

  // Lần 1
  let response = await putOnce(body);
  if (!response.ok && (response.status === 422 || response.status === 409)) {
    // Có thể do thiếu/không đúng SHA -> lấy lại SHA và thử lại 1 lần
    try { currentSha = await fetchCurrentSha(); } catch(e) { currentSha = null; }
    body = { message: GH_COMMIT_MESSAGE, content: base64, branch: GH_DEFAULT.branch };
    if (currentSha) body.sha = currentSha;
    response = await putOnce(body);
  }

  if (!response.ok) {
    const errorText = await response.text();
    throw new Error(`GitHub API ${response.status}: ${errorText}`);
  }

  const result = await response.json();
  ghShaCache = (result.content && result.content.sha) || null;
  console.log('Đã commit thành công lên GitHub');
  return true;
}

// Đồng bộ dữ liệu với GitHub
async function syncWithGitHub() {
  try {
    const success = await loadFromGitHub();
    if (success) {
      renderTable();
      showStatus('Đã đồng bộ dữ liệu từ GitHub', 'success');
    } else {
      showStatus('Không thể tải dữ liệu từ GitHub', 'error');
    }
  } catch (error) {
    showStatus('Lỗi đồng bộ: ' + error.message, 'error');
  }
}

// Hiển thị trạng thái
function showStatus(message, type = 'info') {
  const statusEl = document.getElementById('createStatus');
  if (statusEl) {
    statusEl.textContent = message;
    statusEl.style.display = 'block';
    statusEl.style.color = type === 'success' ? '#0a0' : type === 'error' ? '#c00' : '#666';
    
    setTimeout(() => {
      statusEl.style.display = 'none';
    }, 5000);
  }
}

/* ========= DOMContentLoaded ========= */
addEventListener('DOMContentLoaded', () => {
  const of=document.getElementById('officer'); if(of) of.value=recall('lastOfficer');
  const pin=document.getElementById('pin'); if(pin) pin.value=recall('lastPin');

  document.getElementById('btnCreate')?.addEventListener('click', ()=>handleCreate().catch(console.error));
  document.getElementById('btnReset')?.addEventListener('click', ()=>{ for(const id of ['name','branch','address','mapsUrl','phone','customerCode','cccd','note']) document.getElementById(id).value=''; });
  document.getElementById('q')?.addEventListener('input', renderTable);

  document.getElementById('btnZipSelected')?.addEventListener('click', ()=> zipSelected().catch(console.error));
  document.getElementById('btnPrintA4')?.addEventListener('click', ()=> printA4Selected().catch(console.error));
  // removed demo add button and handler
  document.getElementById('btnClearAll')?.addEventListener('click', ()=>{
    // Tạo modal xác nhận (thay prompt/confirm)
    const modal=document.createElement('div');
    modal.className='modal';
    modal.id='clearModal';
    modal.innerHTML=`
      <div class="content blink-red-infinite">
        <div class="confirm-card">
          <h3 style="margin:0">Xóa toàn bộ dữ liệu?</h3>
          <div class="muted">Nhập mã xác nhận để tiếp tục</div>
          <input id="clearCode" type="password" placeholder="Nhập mã..." style="padding:12px 14px;border:1px solid #ddd;border-radius:10px;">
          <div class="actions">
            <button id="clearCancel" class="btn-secondary">Hủy</button>
            <button id="clearOk" class="btn-danger">Xóa</button>
          </div>
        </div>
      </div>`;
    document.body.appendChild(modal);
    const close=()=> modal.remove();
    modal.addEventListener('click',(e)=>{ if(e.target===modal) close(); });
    modal.querySelector('#clearCancel')?.addEventListener('click', close);
        // ...existing code...
    modal.querySelector('#clearOk')?.addEventListener('click', async ()=>{
      const code=(document.getElementById('clearCode')?.value||'').trim();
      if(code!=='Adme@nPC'){
        const box=modal.querySelector('.content');
        box?.classList.add('blink-red');
        setTimeout(()=> box?.classList.remove('blink-red'), 900);
        return;
      }
      const listCard=document.querySelector('main > section.card:nth-of-type(2)');
      const listWrap=document.querySelector('#list .table-wrap') || document.getElementById('list');
      if(listWrap) listWrap.classList.add('flash-danger');
      if(listCard) listCard.classList.add('flash-danger');
      setTimeout(async ()=>{
        if(listWrap) listWrap.classList.remove('flash-danger');
        if(listCard) listCard.classList.remove('flash-danger');
                 items=[]; saveItems(items); renderTable();
         try { 
           await saveToGitHub(); 
           showStatus('Đã xóa toàn bộ thành công lên GitHub!', 'success');
         } catch(e) { 
           console.error('GitHub save failed', e);
           showStatus('Lỗi xóa toàn bộ lên GitHub: ' + e.message, 'error');
         }
         close();
      }, 1200);
    });    
  });

  // Map helpers + modal
  document.getElementById('btnUseCurrent')?.addEventListener('click', useCurrentPosition);
  document.getElementById('btnPickOnMap')?.addEventListener('click', openPickOnMap);
  document.getElementById('btnOpenMaps')?.addEventListener('click', openMapsTab);
  document.getElementById('btnCloseModal')?.addEventListener('click', closePickOnMap);
  // Thiết lập Token GitHub (obfuscate, lưu localStorage và tự copy)
  /*document.getElementById('btnSetToken')?.addEventListener('click', async ()=>{
    const input = prompt('Nhập GitHub Personal Access Token (PAT):', '');
    if(!input) return;
    try{
      const obf = ghObfEncode(input, GH_XOR_KEY);
      localStorage.setItem('gh_token_obf', obf);
      try{ await navigator.clipboard.writeText(obf); }catch{}
      alert('Đã lưu token (obfuscate) vào trình duyệt và sao chép chuỗi obfuscate vào clipboard.\nHãy dán vào code (GH_TOKEN_FALLBACK) nếu muốn cố định, hoặc chỉ cần refresh để dùng token trong trình duyệt.');
    }catch(e){ alert('Không lưu được token: '+e.message); }
  });*/
  document.getElementById('btnUseCoords')?.addEventListener('click', async () => {
    if (!picked) return alert('Hãy bấm vào bản đồ để chọn vị trí.');
    document.getElementById('mapsUrl').value = gmLinkFromLatLng(picked.lat, picked.lng);
    try{
      const addr = await reverseGeocode(picked.lat, picked.lng);
      if (addr) document.getElementById('address').value = addr;
    }catch{}
    closePickOnMap();
  });
  document.getElementById('btnReverseAddress')?.addEventListener('click', async () => {
    if (!picked) return alert('Chưa có tọa độ.');
    const addr = await reverseGeocode(picked.lat, picked.lng);
    if (addr) document.getElementById('address').value = addr;
  });
  document.getElementById('searchPlace')?.addEventListener('keydown', async (e)=>{ if(e.key!=='Enter') return; e.preventDefault(); const q=e.target.value.trim(); if(!q) return; const r=await searchPlaceByText(q); if(!r) return alert('Không tìm thấy địa chỉ.'); map.setView([r.lat,r.lng],17); setPicked({lat:r.lat,lng:r.lng}); });

  // Scan QR từ ảnh
  const btnScan=document.getElementById('btnScan'); const scanFile=document.getElementById('scanFile');
  btnScan?.addEventListener('click', ()=> scanFile.click());
  scanFile?.addEventListener('change', async (e)=>{ const file=e.target.files?.[0]; if(!file) return;
    try{
      if('BarcodeDetector' in window){
        const det=new BarcodeDetector({formats:['qr_code']});
        const bmp=await createImageBitmap(file);
        const cvs=document.createElement('canvas'); cvs.width=bmp.width; cvs.height=bmp.height; const ctx=cvs.getContext('2d'); ctx.drawImage(bmp,0,0);
        const codes=await det.detect(cvs);
        if(codes && codes[0]){ document.getElementById('mapsUrl').value=codes[0].rawValue; alert('Đã lấy link từ QR.'); }
        else alert('Không đọc được QR trong ảnh.');
      } else { alert('Trình duyệt không hỗ trợ quét QR trực tiếp.'); }
    }catch(err){ console.error(err); alert('Không quét được QR.'); } finally{ e.target.value=''; }
  });

     // Nút đồng bộ GitHub
   document.getElementById('btnSyncGitHub')?.addEventListener('click', ()=>{
     syncWithGitHub().catch(console.error);
   });

  // Footer year & GH bind
  const yEl=document.getElementById('yearNow'); if(yEl) yEl.textContent=new Date().getFullYear();
});
// ====== Token Modal – mở/đóng và thao tác ======
function openTokenModal(){
  const m = document.getElementById('tokenModal');
  updateTokenModalUI();
  m.classList.remove('hidden');
  document.body.classList.add('no-scroll');
}
function closeTokenModal(){
  const m = document.getElementById('tokenModal');
  m.classList.add('hidden');
  document.body.classList.remove('no-scroll');
}
function updateTokenModalUI(){
  const plain = getGhToken();
  const b64 = getGhTokenB64();
  const st = document.getElementById('tokStatus');
  const pv = document.getElementById('tokPreview');
  const b64El = document.getElementById('tokB64');
  if(st) st.textContent = plain ? 'ĐÃ THIẾT LẬP' : 'CHƯA THIẾT LẬP';
  if(pv) pv.textContent = maskToken(plain);
  if(b64El) b64El.value = b64;
  const inp = document.getElementById('tokPlain');
  if(inp) inp.value = '';
}

document.getElementById('btnSetToken')?.addEventListener('click', openTokenModal);

// Nút lưu (ghi base64 vào localStorage)
document.addEventListener('click', async (e)=>{
  const t = e.target;

  if(t.id === 'tokSaveLS'){
    const raw = (document.getElementById('tokPlain')?.value || '').trim();
    if(!raw){ alert('Vui lòng nhập PAT (ghp_… hoặc github_pat_…)'); return; }
    try{
      localStorage.setItem('gh_token_b64', btoa(raw));
      updateTokenModalUI();
      alert('Đã lưu token vào trình duyệt (base64). Bạn có thể thử “🔄 Đồng bộ GitHub”.');
    }catch(err){ alert('Không thể lưu token: '+err.message); }
  }

  // Mã hoá ô plain và copy Base64
  if(t.id === 'tokCopyB64FromPlain'){
    const raw = (document.getElementById('tokPlain')?.value || '').trim();
    if(!raw){ alert('Nhập PAT ở ô trên trước đã.'); return; }
    const b64 = btoa(raw);
    try{ await navigator.clipboard.writeText(b64); alert('Đã copy Base64 từ ô nhập.'); }
    catch{ prompt('Copy chuỗi Base64:', b64); }
  }

  // Copy Base64 hiện có (đang lưu)
  if(t.id === 'tokCopyB64Current'){
    const b64 = (document.getElementById('tokB64')?.value || '').trim();
    if(!b64){ alert('Chưa có token trong localStorage.'); return; }
    try{ await navigator.clipboard.writeText(b64); alert('Đã copy Base64 hiện có.'); }
    catch{ prompt('Copy chuỗi Base64:', b64); }
  }

  // Xoá token khỏi localStorage
  if(t.id === 'tokDelete'){
    try{ localStorage.removeItem('gh_token_b64'); updateTokenModalUI(); alert('Đã xoá token khỏi trình duyệt.'); }
    catch(err){ alert('Không xoá được: '+err.message); }
  }

  // Đóng modal
  if(t.id === 'tokClose' || t.id === 'tokenModal'){
    if(t.id === 'tokenModal') { // click nền tối
      const content = document.querySelector('#tokenModal .content');
      if(content && content.contains(e.target)) return; // click bên trong -> bỏ qua
    }
    closeTokenModal();
  }
});


</script>

<!-- Modal Map Picker -->
<div id="mapModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="mapTitle">
  <div class="content">
    <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
      <h3 id="mapTitle" style="margin:0; font-size:16px;">Chọn vị trí trên bản đồ</h3>
      <div style="flex:1"></div>
      <button id="btnCloseModal" class="btn-secondary" type="button">Đóng</button>
    </div>
    <div id="map"></div>
    <div class="actions" style="margin-top:10px;">
      <input id="searchPlace" type="text" placeholder="Tìm địa chỉ (Enter)" style="flex:1; min-width:180px; padding:10px 10px; border:1px solid #ddd; border-radius:10px;" />
      <button id="btnUseCoords" class="btn-primary" type="button">Dùng tọa độ này</button>
      <button id="btnReverseAddress" class="btn-secondary" type="button">Thử lấy địa chỉ</button>
    </div>
    <div id="pickedInfo" class="muted" style="margin-top:6px; min-height:18px;"></div>
  </div>
</div>
<!-- Modal Thiết lập Token -->
<div id="tokenModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="tokenTitle">
  <div class="content" style="width:min(560px,96vw);height:auto;padding:16px;">
    <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
      <h3 id="tokenTitle" style="margin:0; font-size:16px;">Thiết lập GitHub Token</h3>
      <div style="flex:1"></div>
      <button id="tokClose" class="btn-secondary" type="button">Đóng</button>
    </div>

    <div class="gh-wrap" style="display:block;">
      <div class="muted" style="margin-bottom:10px;">
        Trạng thái: <b id="tokStatus">CHƯA THIẾT LẬP</b> — Token: <span id="tokPreview" class="code">(chưa có)</span>
      </div>

      <label>Nhập PAT (ghp_… hoặc github_pat_…)</label>
      <input id="tokPlain" type="password" placeholder="Dán PAT của bạn vào đây…"/>

      <div class="actions" style="margin-top:10px;">
        <button id="tokSaveLS" class="btn-primary">Lưu vào trình duyệt</button>
        <button id="tokCopyB64FromPlain" class="btn-secondary">Mã hoá &amp; Copy Base64</button>
      </div>

      <label style="margin-top:12px;">Base64 đang lưu (localStorage.gh_token_b64)</label>
      <input id="tokB64" type="text" readonly />

      <div class="actions" style="margin-top:10px; justify-content:space-between;">
        <div style="display:flex; gap:8px;">
          <button id="tokCopyB64Current" class="btn-secondary">Copy Base64 hiện có</button>
          <button id="tokDelete" class="btn-danger">Xoá token khỏi trình duyệt</button>
        </div>
        <button id="tokClose" class="btn-secondary">Đóng</button>
      </div>      
    </div>
  </div>
</div>
</body>
</html>
