<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agribank Chi nh√°nh C·∫ßn Th∆° II ‚Ä¢ C√¥ng c·ª• QR ƒë·ªãa ch·ªâ</title>
  <link rel="icon" href="agribank-logo.png" type="image/png">
  <link rel="apple-touch-icon" href="agribank-logo.png">
  <style>
  :root{
    --primary:#7a001f;        /* Agribank maroon */
    --primary-600:#5f0017;
    --accent:#c2a65c;         /* gold-ish accent */
    --bg:#ffffff;
    --text:#1f1f1f;
    --muted:#666;
    --border:#e8e8e8;
    --thead-bg:#f7eef1;       /* soft maroon tint */
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:0; background:var(--bg); color:var(--text)}

  /* Header g·ªçn */
  header.hero{display:flex; align-items:center; gap:10px; padding:6px 14px; border-bottom:2px solid var(--primary); background:#fff;}
  header.hero .logo{height:40px; width:40px; object-fit:contain}
  header.hero .title{ text-align:center; flex:1; }
  header.hero h1{margin:0; font-size:20px; line-height:1.1; letter-spacing:.6px; text-transform:uppercase; color:var(--primary)}
  header.hero h3{ margin:2px 0 0; font-size:18px; line-height:1.1; font-weight:800; color:var(--primary); letter-spacing:.9px; text-transform:uppercase; }
  header.hero .ghost{ width:40px; height:40px; }

  main{max-width:1100px; margin:20px auto; padding:0 16px}

  .card{background:#fff; border:1px solid var(--border); border-radius:12px; padding:16px; margin-bottom:16px}
  label{display:block; font-weight:600; margin:8px 0 6px}
  input[type="text"], input[type="file"], input[type="password"], input[type="url"], input[type="number"], textarea{width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; font-size:14px}
  input:focus, textarea:focus{outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(122,0,31,.12)}

  .grid{display:grid; gap:12px}
  .grid.cols-3{grid-template-columns:repeat(3,1fr)}
  .grid.cols-2{grid-template-columns:repeat(2,1fr)}

  .actions{display:flex; gap:10px; margin-top:12px; flex-wrap:wrap}
  button{cursor:pointer; border:0; padding:10px 14px; border-radius:10px; font-weight:700; letter-spacing:.2px}
  .btn-primary{background:var(--primary); color:#fff}
  .btn-primary:hover{background:var(--primary-600)}
  .btn-secondary{background:#fff; color:var(--primary); border:1px solid var(--primary)}
  .btn-secondary:hover{background:#faf4f6}
  .btn-danger{background:#b42318; color:#fff}

  .toolbar{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .toolbar .spacer{flex:1}

  table{width:100%; border-collapse:separate; border-spacing:0; background:#fff; border:1px solid var(--border); border-radius:12px; overflow:hidden}
  thead th{background:var(--thead-bg); color:var(--primary); font-weight:700}
  th,td{padding:9px 10px; border-bottom:1px solid var(--border); text-align:left; font-size:13px; vertical-align:top}
  tbody tr:nth-child(even){background:#fbfbfb}
  tbody tr:hover{background:#f6f6f6}

  .code{font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .qr{width:56px; height:56px; object-fit:contain; border:1px solid var(--border); border-radius:8px; background:#fff}
  .empty{color:#777; font-style:italic; padding:12px}
  a{color:var(--primary); text-decoration:none}
  .muted{color:var(--muted); font-size:12px}
  .status{padding:6px 10px; border-radius:10px; background:#f2f2f2}
  .tip{background:#fff7e6; border:1px solid #ffe7ba; padding:10px 12px; border-radius:10px; color:#7a4b00}

  .note{font-size:12px; color:#666}
  .inline-btns button{padding:6px 10px; font-weight:600; border-radius:8px}
  .inline-btns .sep{color:#bbb}

  /* Footer */
  .site-footer{margin-top:28px;background:var(--primary);color:#fff}
  .site-footer .inner{max-width:1100px;margin:0 auto;padding:16px;display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .site-footer .copy{display:flex;flex-direction:column;gap:4px}
  .site-footer .line1{font-weight:600;letter-spacing:.2px}
  .site-footer .line2{font-weight:700;text-transform:uppercase;color:#fff;letter-spacing:.6px}
  .site-footer a{color:#fff;text-decoration:none;border-bottom:1px dotted rgba(255,255,255,.6)}
  .site-footer .right{font-size:12px;opacity:.9}
  @media (max-width:720px){ .site-footer .inner{justify-content:center;text-align:center} .site-footer .right{width:100%; order:3} }

  /* Modal map picker */
  .modal{position:fixed; inset:0; background:rgba(0,0,0,.35); display:flex; align-items:center; justify-content:center; padding:16px; z-index:9999}
  .modal.hidden{display:none}
  .modal .content{width:min(900px,96vw); height:min(74vh,720px); background:#fff; border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.2); display:flex; flex-direction:column; padding:12px}
  #map{flex:1; border-radius:12px; border:1px solid var(--border)}
  .spacer{flex:1}

  /* QR status banner */
  #qrStatus{display:none; align-items:center; gap:8px; padding:8px 12px; border-radius:10px; background:#fff7e6; border:1px solid #ffe7ba; color:#7a4b00; margin:8px 0}
  #qrStatus.show{display:flex}

  @media (max-width: 900px){ .grid.cols-3{grid-template-columns:1fr} }
  /* Keep header text on one line on desktop */
  header.hero .title h1, header.hero .title h3{ white-space:nowrap; }
  @media (max-width: 720px){
    header.hero{flex-direction:column; text-align:center}
    header.hero .ghost{display:none}
    header.hero .title h1, header.hero .title h3{ white-space:normal }
  }
</style>
  <!-- Styles for Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <!-- Vendor scripts (defer) -->
  <script defer src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script defer src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
</head>
<body>
  <header class="hero">
    <img class="logo" src="agribank-logo.png" alt="Agribank" onerror="this.style.display='none'"/>
    <div class="title">
      <h1>Ng√¢n h√†ng N√¥ng nghi·ªáp v√† Ph√°t tri·ªÉn N√¥ng th√¥n</h1>
      <h3>CHI NH√ÅNH C·∫¶N TH∆† II</h3>
    </div>
    <div class="ghost" aria-hidden="true"></div>
  </header>
  <main>
    <section class="card">
      <h2>Th√™m ƒë·ªãa ch·ªâ</h2>
      <p>Ch·∫°y thu·∫ßn <b>HTML/JS</b> tr√™n GitHub Pages (kh√¥ng c·∫ßn NodeJS). D·ªØ li·ªáu s·∫Ω l∆∞u t·∫°m trong tr√¨nh duy·ªát, v√† b·∫°n c√≥ th·ªÉ <b>t·∫£i file <code>data.xlsx</code></b> ƒë·ªÉ up l·∫°i v√†o c√πng th∆∞ m·ª•c tr√™n GitHub.</p>
      <div id="qrStatus" class="tip"><span>‚è≥ ƒêang t·∫£i th∆∞ vi·ªán QR‚Ä¶ s·∫Ω t·ª± th·ª≠ l·∫°i n·∫øu m·∫°ng ch·∫≠m.</span></div>
      <div class="grid cols-3">
        <div>
          <label for="officer">C√°n b·ªô nh·∫≠p *</label>
          <input id="officer" type="text" placeholder="VD: Nguy·ªÖn VƒÉn B" />
        </div>
        <div>
          <label for="pin">PIN (t√πy ch·ªçn)</label>
          <input id="pin" type="password" placeholder="Nh·∫≠p PIN ƒë·ªÉ kh√≥a s·ª≠a/x√≥a" />
        </div>
        <div>
          <label for="name">T√™n ƒë·ªãa ƒëi·ªÉm *</label>
          <input id="name" type="text" placeholder="VD: H·ªô kinh doanh Nguy·ªÖn A" />
        </div>
        <div>
          <label for="address">ƒê·ªãa ch·ªâ (n·∫øu kh√¥ng c√≥ link)</label>
          <input id="address" type="text" placeholder="VD: 10 Ch√πa B·ªôc, ƒê·ªëng ƒêa, H√† N·ªôi" />
        </div>
        <div>
          <label for="mapsUrl">Ho·∫∑c d√°n link Google Maps</label>
          <input id="mapsUrl" type="text" placeholder="https://maps.app.goo.gl/..." />
          <div class="actions" id="mapsHelpers" style="margin-top:6px; gap:8px;">
            <button id="btnUseCurrent" type="button" class="btn-secondary">üìç D√πng v·ªã tr√≠ hi·ªán t·∫°i</button>
            <button id="btnPickOnMap" type="button" class="btn-secondary">üó∫Ô∏è Ch·ªçn tr√™n b·∫£n ƒë·ªì</button>
            <button id="btnOpenMaps" type="button" class="btn-secondary" title="M·ªü Google Maps ·ªü tab m·ªõi, b·∫°n c√≥ th·ªÉ b·∫•m Chia s·∫ª/Copy Link r·ªìi d√°n v√†o √¥ n√†y">M·ªü Google Maps</button>
          </div>
        </div>
        <div>
          <label for="phone">S·ªë ƒëi·ªán tho·∫°i</label>
          <input id="phone" type="text" placeholder="VD: 0987..." />
        </div>
        <div>
          <label for="group">Nh√≥m</label>
          <input id="group" type="text" placeholder="VD: Nh√≥m A / Khu v·ª±c 1" />
        </div>
        <div>
          <label for="customerCode">M√£ KH</label>
          <input id="customerCode" type="text" placeholder="VD: KH00123" />
        </div>
        <div>
          <label for="cccd">CCCD</label>
          <input id="cccd" type="text" placeholder="12 s·ªë" />
        </div>
        <div class="cols-2" style="grid-column: span 2;">
          <label for="note">Ghi ch√∫</label>
          <input id="note" type="text" placeholder="VD: Nh√† m·∫∑t ti·ªÅn, gi·ªù m·ªü c·ª≠a, ng∆∞·ªùi li√™n h·ªá..." />
        </div>
      </div>
      <div class="actions">
        <button class="btn-primary" id="btnCreate">T·∫°o m·ª•c</button>
        <button class="btn-secondary" id="btnQuickPrint" title="T·∫°o QR t·ª´ th√¥ng tin ƒëang nh·∫≠p v√† in ngay (kh√¥ng l∆∞u)">In QR nhanh</button>
        <button class="btn-secondary" id="btnReset">X√≥a form</button>
        <span class="muted">* B·∫Øt bu·ªôc</span>
      </div>
      <div class="tip" style="margin-top:10px;">M·∫πo: Nh·∫≠p 1 l·∫ßn <b>C√°n b·ªô</b> v√† <b>PIN</b> (n·∫øu d√πng), l·∫ßn sau s·∫Ω ƒë∆∞·ª£c nh·ªõ tr√™n thi·∫øt b·ªã n√†y.</div>
    </section>

    <section class="card">
      <h2>Nh·∫≠p nhanh (di ƒë·ªông) ‚Äì Qu√©t QR ƒë·ªÉ l·∫•y link Maps</h2>
      <div class="actions">
        <input id="scanFile" type="file" accept="image/*" capture="environment" style="display:none" />
        <button id="btnScan" class="btn-secondary">üì∑ Qu√©t QR t·ª´ camera/·∫£nh</button>
        <span class="muted">Chrome/Android h·ªó tr·ª£ t·ªët. N·∫øu kh√¥ng ƒë·ªçc ƒë∆∞·ª£c, m·ªü camera ‚Üí qu√©t QR ‚Üí copy URL ‚Üí d√°n v√†o √¥ Link.</span>
      </div>
    </section>

    <section class="card">
      <div class="toolbar">
        <h2 style="margin:0">Danh s√°ch ƒë√£ nh·∫≠p</h2>
        <div class="spacer"></div>
        <input id="q" type="text" placeholder="T√¨m theo t√™n/nh√≥m/m√£ KH/sƒët/c√°n b·ªô" style="min-width:260px; padding:8px 10px; border:1px solid #ddd; border-radius:10px;" />
        <label class="btn-secondary" style="padding:8px 12px; border-radius:10px;">
          Nh·∫≠p t·ª´ Excel
          <input id="fileInput" type="file" accept=".xlsx,.xls" style="display:none" />
        </label>
        <button class="btn-secondary" id="btnExport">T·∫£i data.xlsx (c√≥ style)</button>
        <button class="btn-secondary" id="btnClearAll" title="X√≥a to√†n b·ªô trong tr√¨nh duy·ªát (kh√¥ng ·∫£nh h∆∞·ªüng file tr√™n GitHub)">X√≥a to√†n b·ªô</button>
        <button class="btn-secondary" id="btnZipSelected" title="T·∫£i ZIP c√°c QR ƒë√£ ch·ªçn">ZIP QR (ƒë√£ ch·ªçn)</button>
        <button class="btn-secondary" id="btnPrintA4" title="In nhi·ªÅu tem tr√™n 1 A4 cho c√°c d√≤ng ƒë√£ ch·ªçn">In A4 (ƒë√£ ch·ªçn)</button>
        <button class="btn-secondary" id="btnAddDemo" title="Th√™m 1 d√≤ng m·∫´u ƒë·ªÉ th·ª≠ nhanh">Th√™m d√≤ng test</button>
      </div>
      <div id="list"></div>
      <div class="muted" style="margin-top:8px;">Khi d√πng tr√™n GitHub Pages: trang <b>kh√¥ng th·ªÉ ghi ng∆∞·ª£c l√™n repo</b>. D√πng ph·∫ßn <b>ƒê·ªìng b·ªô GitHub</b> ·ªü d∆∞·ªõi ƒë·ªÉ commit qua API.</div>
      <div class="muted">Trang s·∫Ω t·ª± <b>ƒë·ªçc <code>data.xlsx</code></b> (n·∫øu c√≥) t·ª´ c√πng th∆∞ m·ª•c khi m·ªü.</div>
    </section>

    <section class="card">
      <h2>ƒê·ªìng b·ªô GitHub (commit tr·ª±c ti·∫øp)</h2>
      <div class="grid cols-3">
        <div>
          <label for="ghOwner">Owner</label>
          <input id="ghOwner" type="text" placeholder="VD: tvnghp" />
        </div>
        <div>
          <label for="ghRepo">Repo</label>
          <input id="ghRepo" type="text" placeholder="VD: diachi" />
        </div>
        <div>
          <label for="ghBranch">Nh√°nh</label>
          <input id="ghBranch" type="text" value="main" />
        </div>
        <div>
          <label for="ghPath">ƒê∆∞·ªùng d·∫´n file</label>
          <input id="ghPath" type="text" value="data.xlsx" />
        </div>
        <div>
          <label for="ghToken">GitHub Token (repo scope)</label>
          <input id="ghToken" type="password" placeholder="ghp_..." />
        </div>
        <div>
          <label for="ghMessage">Th√¥ng ƒëi·ªáp commit</label>
          <input id="ghMessage" type="text" value="C·∫≠p nh·∫≠t data.xlsx t·ª´ c√¥ng c·ª• QR" />
        </div>
      </div>
      <div class="actions">
        <button class="btn-secondary" id="btnGhLoad">T·∫£i t·ª´ GitHub</button>
        <button class="btn-primary" id="btnGhSave">L∆∞u l√™n GitHub</button>
        <span class="note">Token ch·ªâ l∆∞u t·∫°m trong <b>session</b> tr√¨nh duy·ªát, kh√¥ng g·ª≠i ƒëi n∆°i kh√°c ngo√†i GitHub API.</span>
      </div>
      <div id="ghStatus" class="muted"></div>
    </section>

    <!-- Modal: Map Picker -->
    <div id="mapModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="mapTitle">
      <div class="content">
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
          <h3 id="mapTitle" style="margin:0; font-size:16px;">Ch·ªçn v·ªã tr√≠ tr√™n b·∫£n ƒë·ªì</h3>
          <div class="spacer"></div>
          <button id="btnCloseModal" class="btn-secondary" type="button">ƒê√≥ng</button>
        </div>
        <div id="map"></div>
        <div class="actions" style="margin-top:10px;">
          <input id="searchPlace" type="text" placeholder="T√¨m ƒë·ªãa ch·ªâ (Enter)" style="flex:1; min-width:220px; padding:8px 10px; border:1px solid #ddd; border-radius:10px;" />
          <button id="btnUseCoords" class="btn-primary" type="button">D√πng t·ªça ƒë·ªô n√†y</button>
          <button id="btnReverseAddress" class="btn-secondary" type="button">Th·ª≠ l·∫•y ƒë·ªãa ch·ªâ</button>
        </div>
        <div id="pickedInfo" class="muted" style="margin-top:6px; min-height:18px;"></div>
      </div>
    </div>
  </main>
<footer class="site-footer">
  <div class="inner">
    <div class="copy">
      <div class="line1">B·∫£n quy·ªÅn ¬© <span id="yearNow"></span> <b>AGRIBANK</b> ‚Äî Ng√¢n h√†ng N√¥ng nghi·ªáp v√† Ph√°t tri·ªÉn N√¥ng th√¥n Vi·ªát Nam</div>
      <div class="line2">CHI NH√ÅNH C·∫¶N TH∆† II ‚Ä¢ All rights reserved.</div>
    </div>
    <div class="right">
      <a href="https://www.agribank.com.vn" target="_blank" rel="noopener">agribank.com.vn</a>
    </div>
  </div>
</footer>
<script>
// ===== Utilities =====
const LS_KEY = 'qr_maps_items_v3';
function uid(n=8){ return Math.random().toString(36).slice(2, 2+n); }
function nowISO(){ return new Date().toISOString(); }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
function escapeHtml(s){
  s = String(s||'');
  s = s.replace(/&/g,'&amp;');
  s = s.replace(/</g,'&lt;');
  s = s.replace(/>/g,'&gt;');
  s = s.replace(/"/g,'&quot;');
  s = s.replace(/'/g,'&#39;');
  return s;
}
function normalizePhone(v){ return String(v||'').replace(/[^0-9+]/g,''); }
function normalizeCCCD(v){ return String(v||'').replace(/[^0-9]/g,''); }
function mapsUrlFromAddress(address){ const q = encodeURIComponent(String(address||'').trim()); return `https://www.google.com/maps/search/?api=1&query=${q}`; }
function remember(k,v){ try{ localStorage.setItem(k,v) }catch(e){} }
function recall(k){ try{ return localStorage.getItem(k)||'' }catch(e){ return '' } }

// WebCrypto SHA-256
async function sha256Hex(str){
  const enc = new TextEncoder().encode(str);
  const buf = await crypto.subtle.digest('SHA-256', enc);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}
function randomHex(bytes=8){ const a = new Uint8Array(bytes); crypto.getRandomValues(a); return Array.from(a).map(b=>b.toString(16).padStart(2,'0')).join(''); }

// ===== Robust QRCode loader with auto-retry =====
function loadScriptOnce(src){
  return new Promise((resolve, reject)=>{
    const s = document.createElement('script');
    s.src = src; s.async = false; s.defer = true;
    s.onload = ()=> resolve();
    s.onerror = ()=> reject(new Error('Failed to load '+src));
    document.head.appendChild(s);
  });
}
let __qrReady = null;
async function ensureQRCode(maxWaitMs=15000){
  if (typeof window.QRCode !== 'undefined' && window.QRCode && window.QRCode.toCanvas) return;
  if (!__qrReady){
    const fallbacks = [
      'https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js',
      'https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.1/qrcode.min.js'
    ];
    __qrReady = (async ()=>{
      for (const url of fallbacks){
        try{ await loadScriptOnce(url); if (typeof window.QRCode !== 'undefined') return; }catch(e){}
      }
      throw new Error('Kh√¥ng t·∫£i ƒë∆∞·ª£c th∆∞ vi·ªán QRCode t·ª´ CDN.');
    })();
  }
  const banner = document.getElementById('qrStatus');
  banner?.classList.add('show');
  const start = Date.now();
  while (Date.now()-start < maxWaitMs){
    try{ await __qrReady; }catch(e){}
    if (typeof window.QRCode !== 'undefined') { banner?.classList.remove('show'); return; }
    await sleep(2000);
  }
  banner?.classList.add('show');
  throw new Error('QRCode ch∆∞a s·∫µn s√†ng. H√£y ki·ªÉm tra m·∫°ng v√† th·ª≠ l·∫°i.');
}

// ===== QR Logo settings =====
const QR_LOGO = {
  enabled: true,
  src: 'agribank-logo.png',
  sizeRatio: 0.22,
  paddingRatio: 0.06,
  rounded: 10
};
let __logoImg = null;
async function loadLogo(){
  if (!QR_LOGO.enabled) return null;
  if (__logoImg) return __logoImg;
  return new Promise((resolve)=>{
    const img = new Image();
    img.onload = ()=>{ __logoImg = img; resolve(img); };
    img.onerror = ()=> resolve(null);
    img.crossOrigin = 'anonymous';
    img.src = QR_LOGO.src;
  });
}
function roundRect(ctx, x, y, w, h, r){
  const rr = Math.min(r, w/2, h/2);
  ctx.beginPath();
  ctx.moveTo(x+rr, y);
  ctx.arcTo(x+w, y, x+w, y+h, rr);
  ctx.arcTo(x+w, y+h, x, y+h, rr);
  ctx.arcTo(x, y+h, x, y, rr);
  ctx.arcTo(x, y, x+w, y, rr);
  ctx.closePath();
}

// ===== Excel schema =====
const HEADERS = ['id','code','name','address','mapsUrl','createdAt','note','phone','group','cccd','customerCode','officer','pinSalt','pinHash'];
function loadItems(){ try{ return JSON.parse(localStorage.getItem(LS_KEY))||[] }catch(e){ return [] } }
function saveItems(arr){ localStorage.setItem(LS_KEY, JSON.stringify(arr)); }
function sheetToJsonStrict(ws){
  const arr = XLSX.utils.sheet_to_json(ws, { defval:'', raw:false });
  return arr.map(r => { const o = {}; for (const h of HEADERS) o[h] = r[h] ?? ''; return o; });
}

// ===== State =====
let items = loadItems();
let selectedIds = new Set();
let fsHandle = null; // File System Access handle

// Seed 1 d√≤ng m·∫´u (khi tr·∫Øng d·ªØ li·ªáu)
function seedDemo(){
  try{ if (items.length>0) return; if (localStorage.getItem('qr_maps_seeded_v1')) return; }catch(e){}
  const addr = '02 H√≤a B√¨nh, Ninh Ki·ªÅu, C·∫ßn Th∆°';
  const demo = { id: uid(12), code: 'DEMO' + uid(4).toUpperCase(), name: 'H·ªô kinh doanh Tr·∫ßn VƒÉn A', address: addr, mapsUrl: mapsUrlFromAddress(addr), createdAt: nowISO(), note: 'D√≤ng m·∫´u ƒë·ªÉ th·ª≠ t√≠nh nƒÉng', phone: '0901234567', group: 'Test', cccd: '012345678901', customerCode: 'KH0001', officer: 'Demo User', pinSalt: '', pinHash: '' };
  items.unshift(demo); saveItems(items);
  try{ localStorage.setItem('qr_maps_seeded_v1','1'); }catch(e){}
}

// Prefill officer/pin
addEventListener('DOMContentLoaded', ()=>{
  document.getElementById('officer').value = recall('lastOfficer');
  document.getElementById('pin').value = recall('lastPin');
});

// ===== Auto-load data.xlsx (c√πng th∆∞ m·ª•c) =====
(async function autoLoad(){
  try{
    const res = await fetch('data.xlsx?t=' + Date.now(), { cache: 'no-store' });
    if (!res.ok) throw 0; const buf = await res.arrayBuffer();
    const wb = XLSX.read(buf, { type:'array' });
    const ws = wb.Sheets[wb.SheetNames[0]]; if (!ws) throw 0;
    const rows = sheetToJsonStrict(ws);
    const have = new Set(items.map(x=>x.id));
    let added = 0; for (const r of rows){ if (!have.has(r.id) && (r.name && (r.address||r.mapsUrl))){ items.push(r); added++; } }
    if (added){ items.sort((a,b)=> new Date(b.createdAt)-new Date(a.createdAt)); saveItems(items); }
  }catch(e){ /* ignore if not found */ }
  if (!items.length) { try { seedDemo(); } catch(e){} }
  renderTable();
})();

// ===== CRUD Handlers =====
async function handleCreate(){
  const officer = document.getElementById('officer').value.trim();
  const pin = document.getElementById('pin').value.trim();
  const name = document.getElementById('name').value.trim();
  const group = document.getElementById('group').value.trim();
  const address = document.getElementById('address').value.trim();
  const mapsUrlInput = document.getElementById('mapsUrl').value.trim();
  const phone = normalizePhone(document.getElementById('phone').value.trim());
  const customerCode = document.getElementById('customerCode').value.trim();
  const cccd = normalizeCCCD(document.getElementById('cccd').value.trim());
  const note = document.getElementById('note').value.trim();
  if (!officer || !name || (!address && !mapsUrlInput)) return alert('Vui l√≤ng nh·∫≠p C√°n b·ªô nh·∫≠p, T√™n v√† (ƒê·ªãa ch·ªâ ho·∫∑c Link Maps).');
  if (cccd && cccd.length !== 12 && !confirm('CCCD kh√¥ng ƒë·ªß 12 s·ªë. V·∫´n l∆∞u?')) return;
  const mapsUrl = mapsUrlInput || mapsUrlFromAddress(address);
  const createdAt = nowISO();
  let pinSalt = '', pinHash = '';
  if (pin){ pinSalt = randomHex(8); pinHash = await sha256Hex(pinSalt + pin); }
  const item = { id: uid(12), code: uid(8), name, address, mapsUrl, createdAt, note, phone, group, cccd, customerCode, officer, pinSalt, pinHash };
  items.unshift(item); saveItems(items); renderTable();
  for (const id of ['name','group','address','mapsUrl','phone','customerCode','cccd','note']) document.getElementById(id).value = '';
  remember('lastOfficer', officer); if (pin) remember('lastPin', pin);
}

document.getElementById('btnCreate').addEventListener('click', ()=>{ handleCreate().catch(console.error); });

document.getElementById('btnReset').addEventListener('click', ()=>{
  for (const id of ['name','group','address','mapsUrl','phone','customerCode','cccd','note']) document.getElementById(id).value = '';
});

document.getElementById('q').addEventListener('input', renderTable);

document.getElementById('fileInput').addEventListener('change', async (e) => {
  const file = e.target.files[0]; if (!file) return;
  const data = await file.arrayBuffer();
  const wb = XLSX.read(new Uint8Array(data), { type: 'array' });
  const ws = wb.Sheets[wb.SheetNames[0]]; if (!ws) return;
  const json = sheetToJsonStrict(ws);
  const have = new Set(items.map(x=>x.id));
  let added = 0; for (const r of json){ if (!have.has(r.id) && (r.name && (r.address || r.mapsUrl))) { items.push(r); added++; } }
  if (added){ items.sort((a,b)=> new Date(b.createdAt)-new Date(a.createdAt)); saveItems(items); renderTable(); }
  e.target.value = '';
});

// ExcelJS export with styles & freeze header
function colLetter(n){ let s=''; while(n){ let m=(n-1)%26; s=String.fromCharCode(65+m)+s; n=(n-m-1)/26 } return s; }
async function buildWorkbook(){
  const wb = new ExcelJS.Workbook();
  const ws = wb.addWorksheet('locations');
  const columns = [
    { header:'id', key:'id', width:25 },
    { header:'code', key:'code', width:12 },
    { header:'name', key:'name', width:30 },
    { header:'address', key:'address', width:40 },
    { header:'mapsUrl', key:'mapsUrl', width:60 },
    { header:'createdAt', key:'createdAt', width:24 },
    { header:'note', key:'note', width:30 },
    { header:'phone', key:'phone', width:18 },
    { header:'group', key:'group', width:18 },
    { header:'cccd', key:'cccd', width:18 },
    { header:'customerCode', key:'customerCode', width:18 },
    { header:'officer', key:'officer', width:24 },
    { header:'pinSalt', key:'pinSalt', width:16, hidden:true },
    { header:'pinHash', key:'pinHash', width:64, hidden:true },
  ];
  ws.columns = columns;
  const header = ws.getRow(1);
  header.font = { bold:true, color:{argb:'FF3B0E40'} };
  header.alignment = { vertical:'middle', horizontal:'center' };
  header.fill = { type:'pattern', pattern:'solid', fgColor:{argb:'FFF6EAF2'} };
  header.border = { bottom:{ style:'thin', color:{argb:'FFCCC0D9'} } };
  header.height = 22;
  ws.addRows(items);
  ws.views = [{ state:'frozen', ySplit:1 }];
  ws.autoFilter = `A1:${colLetter(columns.length)}1`;
  return wb;
}
async function exportStyledExcel(){
  const wb = await buildWorkbook();
  const buf = await wb.xlsx.writeBuffer();
  const blob = new Blob([buf], { type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
  const a = document.createElement('a'); const url = URL.createObjectURL(blob);
  a.href = url; a.download = 'data.xlsx'; a.click(); setTimeout(()=>URL.revokeObjectURL(url), 1000);
}

document.getElementById('btnExport').addEventListener('click', ()=>{ exportStyledExcel().catch(console.error); });

// ===== File System Access (m·ªü/l∆∞u tr·ª±c ti·∫øp local) =====
async function openFS(){
  if (!window.showOpenFilePicker){ alert('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ m·ªü file tr·ª±c ti·∫øp. D√πng n√∫t "Nh·∫≠p t·ª´ Excel" nh√©.'); return; }
  const [handle] = await window.showOpenFilePicker({ types:[{ description:'Excel', accept:{ 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet':['.xlsx'] } }] });
  fsHandle = handle; const btn = document.getElementById('btnSaveFS'); if (btn) btn.disabled = false;
  const file = await handle.getFile(); const buf = await file.arrayBuffer();
  const wb = XLSX.read(buf, { type:'array' });
  const ws = wb.Sheets[wb.SheetNames[0]]; if (!ws) return;
  const json = sheetToJsonStrict(ws);
  items = json.filter(r=>r.name && (r.address||r.mapsUrl)); saveItems(items); renderTable();
}
async function saveFS(){
  if (!fsHandle){ alert('Ch∆∞a m·ªü file n√†o.'); return; }
  const wb = await buildWorkbook(); const buf = await wb.xlsx.writeBuffer();
  const writable = await fsHandle.createWritable(); await writable.write(buf); await writable.close(); alert('ƒê√£ l∆∞u v√†o file.');
}

// ===== GitHub Commit (Contents API) =====
const GH_CFG_KEY = 'qr_maps_github_cfg_v1';
let ghShaCache = null;
function readGhCfg(){
  const cfg = { owner:'', repo:'', branch:'main', path:'data.xlsx', message:'C·∫≠p nh·∫≠t data.xlsx t·ª´ c√¥ng c·ª• QR' };
  try{ Object.assign(cfg, JSON.parse(localStorage.getItem(GH_CFG_KEY)||'{}')); }catch{}
  cfg.token = sessionStorage.getItem('gh_token')||'';
  return cfg;
}
function writeGhCfg(part){
  const cur = readGhCfg(); Object.assign(cur, part);
  sessionStorage.setItem('gh_token', cur.token||'');
  const copy = Object.assign({}, cur); delete copy.token; localStorage.setItem(GH_CFG_KEY, JSON.stringify(copy));
}
function bindGhInputs(){
  const cfg = readGhCfg();
  for (const [id,val] of Object.entries({ ghOwner:cfg.owner, ghRepo:cfg.repo, ghBranch:cfg.branch, ghPath:cfg.path, ghMessage:cfg.message })){
    const el = document.getElementById(id); if (el) el.value = val;
  }
  const t = document.getElementById('ghToken'); if (t) t.value = cfg.token;
}
function collectGhInputs(){
  const owner = document.getElementById('ghOwner').value.trim();
  const repo = document.getElementById('ghRepo').value.trim();
  const branch = document.getElementById('ghBranch').value.trim()||'main';
  const path = document.getElementById('ghPath').value.trim()||'data.xlsx';
  const token = document.getElementById('ghToken').value.trim();
  const message = document.getElementById('ghMessage').value.trim()||'Update via tool';
  const cfg = { owner, repo, branch, path, token, message };
  writeGhCfg(cfg); return cfg;
}
function ab2b64(buf){
  const bytes = new Uint8Array(buf); let bin='';
  for (let i=0;i<bytes.length;i++){ bin += String.fromCharCode(bytes[i]); }
  return btoa(bin);
}
async function ghRequest(method, url, token, body){
  const res = await fetch(url, { method, headers:{ 'Accept':'application/vnd.github+json', 'Authorization': 'token '+token, 'Content-Type':'application/json' }, body: body? JSON.stringify(body): undefined });
  if (!res.ok){ const txt = await res.text(); throw new Error(`GitHub API ${res.status}: ${txt}`); }
  return res.json();
}
async function ghGetFile(cfg){
  const url = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${encodeURIComponent(cfg.path)}?ref=${encodeURIComponent(cfg.branch)}`;
  const j = await ghRequest('GET', url, cfg.token);
  ghShaCache = j.sha || null; return j;
}
async function ghPutFile(cfg, base64){
  const url = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${encodeURIComponent(cfg.path)}`;
  const body = { message: cfg.message, content: base64, branch: cfg.branch };
  if (ghShaCache) body.sha = ghShaCache;
  const j = await ghRequest('PUT', url, cfg.token, body);
  ghShaCache = (j.content && j.content.sha) || null; return j;
}
async function githubLoad(){
  const cfg = collectGhInputs(); const out = document.getElementById('ghStatus'); out.textContent = 'ƒêang t·∫£i t·ª´ GitHub...';
  try{
    if (!cfg.owner || !cfg.repo || !cfg.token){ throw new Error('ƒêi·ªÅn Owner/Repo/Token tr∆∞·ªõc.'); }
    const info = await ghGetFile(cfg);
    if (!info.content){ throw new Error('Kh√¥ng th·∫•y n·ªôi dung file trong API.'); }
    const buf = Uint8Array.from(atob(info.content), c=>c.charCodeAt(0)).buffer;
    const wb = XLSX.read(buf, { type:'array' });
    const ws = wb.Sheets[wb.SheetNames[0]]; if (!ws) throw new Error('Kh√¥ng c√≥ sheet n√†o.');
    const json = sheetToJsonStrict(ws);
    items = json.filter(r=>r.name && (r.address||r.mapsUrl)); saveItems(items); renderTable();
    out.textContent = 'ƒê√£ t·∫£i xong t·ª´ GitHub.';
  }catch(e){ out.textContent = 'L·ªói: '+ e.message; }
}
async function githubSave(){
  const cfg = collectGhInputs(); const out = document.getElementById('ghStatus'); out.textContent = 'ƒêang t·∫°o file Excel v√† commit...';
  try{
    if (!cfg.owner || !cfg.repo || !cfg.token){ throw new Error('ƒêi·ªÅn Owner/Repo/Token tr∆∞·ªõc.'); }
    // refresh sha (to tr√°nh conflict)
    try{ await ghGetFile(cfg); }catch{ ghShaCache = null; }
    const wb = await buildWorkbook(); const buf = await wb.xlsx.writeBuffer();
    const b64 = ab2b64(buf);
    await ghPutFile(cfg, b64);
    out.textContent = '‚úÖ ƒê√£ commit data.xlsx l√™n GitHub.';
  }catch(e){ out.textContent = 'L·ªói: '+ e.message; }
}

document.getElementById('btnGhLoad').addEventListener('click', ()=> githubLoad().catch(console.error));

document.getElementById('btnGhSave').addEventListener('click', ()=> githubSave().catch(console.error));

bindGhInputs();

// ===== Selection / ZIP / Print A4 =====
function getSelectedItems(){ return items.filter(x=> selectedIds.has(x.id)); }
function dataURLtoBlob(dataURL){ const parts = dataURL.split(','); const bstr = atob(parts[1]); const u8 = new Uint8Array(bstr.length); for (let i=0;i<bstr.length;i++) u8[i]=bstr.charCodeAt(i); return new Blob([u8], { type: 'image/png' }); }
async function zipSelected(){
  const sel = getSelectedItems(); if (!sel.length) return alert('H√£y ch·ªçn √≠t nh·∫•t 1 d√≤ng.');
  const zip = new JSZip();
  for (const it of sel){ const dataUrl = await makeQRDataUrl(it.mapsUrl, 1024); const blob = dataURLtoBlob(dataUrl); const fname = `QR_${it.code}_${(it.name||'').replace(/\s+/g,'_').slice(0,50)}.png`; zip.file(fname, blob); }
  const out = await zip.generateAsync({ type:'blob' });
  const a = document.createElement('a'); const url = URL.createObjectURL(out); a.href = url; a.download = 'qr_da_chon.zip'; a.click(); setTimeout(()=>URL.revokeObjectURL(url), 1500);
}
async function printA4Selected(){
  const sel = getSelectedItems(); if (!sel.length) return alert('H√£y ch·ªçn √≠t nh·∫•t 1 d√≤ng.');
  const data = []; for (const it of sel){ data.push({ it, qr: await makeQRDataUrl(it.mapsUrl, 1024) }); }
  const win = window.open('', '_blank');
  const tiles = data.map(d=>`
    <div class="tile">
      <img src="${d.qr}" />
      <div class="t">
        <div class="n">${escapeHtml(d.it.name)}</div>
        <div class="a">${escapeHtml(d.it.address||'')}</div>
        <div class="m">${escapeHtml(d.it.mapsUrl)}</div>
      </div>
    </div>`).join('');
  win.document.write(`<!doctype html>
<html><head><meta charset="utf-8"><title>In tem A4</title>
<style>
  @page { size: A4; margin: 8mm; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin:0; }
  .actions { position: fixed; top:8px; right:8px; }
  @media print { .actions { display:none; } }
  .sheet { display:grid; grid-template-columns: repeat(3, 1fr); gap: 6mm; padding: 8mm; }
  .tile { border:1px dashed #ddd; padding:3mm; display:flex; gap:3mm; align-items:center; }
  .tile img { width: 28mm; height: 28mm; object-fit:contain; border:1px solid #eee; border-radius:4mm; background:#fff; }
  .t { font-size: 3.2mm; }
  .t .n { font-weight:700; margin-bottom:1mm; }
  .t .m { font-family: ui-monospace, Menlo, Consolas, monospace; word-break: break-all; color:#555; font-size: 3mm; }
</style></head>
<body>
  <div class="actions"><button onclick="window.print()">In</button></div>
  <div class="sheet">${tiles}</div>
</body></html>`);
  win.document.close();
}

document.getElementById('btnZipSelected').addEventListener('click', ()=>{ zipSelected().catch(console.error); });

document.getElementById('btnPrintA4').addEventListener('click', ()=>{ printA4Selected().catch(console.error); });

// ===== Add demo row =====
function addDemoRow(){
  const officer = (document.getElementById('officer').value||'Demo User').trim() || 'Demo User';
  const name = 'H·ªô kinh doanh Test ' + uid(4).toUpperCase();
  const addr = '02 H√≤a B√¨nh, Ninh Ki·ªÅu, C·∫ßn Th∆°';
  const item = { id: uid(12), code: 'TEST' + uid(4).toUpperCase(), name, address: addr, mapsUrl: mapsUrlFromAddress(addr), createdAt: nowISO(), note: 'D√≤ng test th√™m nhanh', phone: '090' + Math.floor(1000000 + Math.random()*8999999), group: 'Test', cccd: '0' + Math.floor(100000000000 + Math.random()*899999999999), customerCode: 'KH' + Math.floor(1000 + Math.random()*9000), officer, pinSalt:'', pinHash:'' };
  items.unshift(item); saveItems(items); renderTable();
}

document.getElementById('btnAddDemo').addEventListener('click', addDemoRow);

// ===== QR helpers =====
async function makeQRDataUrl(text, size=512){
  try{ await ensureQRCode(); }catch(e){ /* show banner & retry later */ }
  // try up to 3 times with backoff
  let lastErr = null;
  for (let i=0;i<3;i++){
    try{
      if (typeof QRCode === 'undefined') throw new Error('QRCode ch∆∞a s·∫µn s√†ng');
      const canvas = document.createElement('canvas');
      await new Promise((resolve, reject)=>{
        QRCode.toCanvas(canvas, text, { width: size, margin: 1, errorCorrectionLevel: 'H' }, err => err ? reject(err) : resolve());
      });
      try{
        const img = await loadLogo();
        if (img){
          const ctx = canvas.getContext('2d');
          const logoSize = Math.round(size * QR_LOGO.sizeRatio);
          const pad = Math.round(size * QR_LOGO.paddingRatio);
          const dx = Math.round((size - logoSize)/2);
          const dy = Math.round((size - logoSize)/2);
          ctx.save(); ctx.fillStyle = '#fff'; roundRect(ctx, dx - pad, dy - pad, logoSize + 2*pad, logoSize + 2*pad, QR_LOGO.rounded); ctx.fill(); ctx.restore();
          ctx.drawImage(img, dx, dy, logoSize, logoSize);
        }
      }catch{}
      return canvas.toDataURL('image/png');
    }catch(err){ lastErr = err; await sleep(2000); }
  }
  throw lastErr || new Error('Kh√¥ng t·∫°o ƒë∆∞·ª£c QR');
}

async function downloadQR(url, filename){
  try{
    const a = document.createElement('a');
    a.href = await makeQRDataUrl(url, 1024);
    a.download = filename || 'qr.png'; a.click();
  }catch(e){ alert('Kh√¥ng t·∫°o ƒë∆∞·ª£c QR (m·∫°ng ch·∫≠m ho·∫∑c th∆∞ vi·ªán ch∆∞a s·∫µn s√†ng). H·ªá th·ªëng s·∫Ω t·ª± th·ª≠ l·∫°i khi b·∫°n thao t√°c l·∫°i.'); }
}

async function openPrint(code, mode='full'){
  const it = items.find(x => x.code === code); if (!it) return;
  let qr = '';
  try { qr = await makeQRDataUrl(it.mapsUrl, 1024); } catch(e) { alert('Kh√¥ng t·∫°o ƒë∆∞·ª£c QR (m·∫°ng ch·∫≠m). Th·ª≠ l·∫°i sau v√†i gi√¢y.'); return; }
  const win = window.open('', '_blank');
  if (mode === 'qr'){
    win.document.write(`<!doctype html>
<html><head><meta charset="utf-8"><title>In QR ‚Äì ${escapeHtml(it.name)}</title>
<style>
  @page { size: A7; margin: 8mm; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin:0; display:flex; justify-content:center; align-items:center; height:100vh; }
  img { width: 65mm; height: 65mm; object-fit:contain; border:1px solid #eee; border-radius:12px; }
  .actions { position: fixed; top:10px; right:10px; }
  @media print { .actions { display:none; } }
</style></head>
<body>
  <div class="actions"><button onclick="window.print()">In</button></div>
  <img src="${qr}" alt="QR ${escapeHtml(it.name)}"/>
</body></html>`);
    win.document.close();
    return;
  }
  // full mode
  win.document.write(`<!doctype html>
<html><head><meta charset="utf-8"><title>In nh√£n ‚Äì ${escapeHtml(it.name)}</title>
<style>
  @page { size: A7; margin: 6mm; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin:0; }
  .label { display:flex; gap:12px; align-items:center; padding: 10px; }
  .qr { width:180px; height:180px; object-fit:contain; border:1px solid #eee; border-radius:12px; }
  h1 { font-size:20px; margin:0 0 4px; }
  .addr { color:#444; }
  .meta { font-size:12px; color:#555; margin-top:6px; }
  .code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; color:#666; font-size:12px; margin-top:4px; }
  .actions { position: fixed; top:10px; right:10px; }
  @media print { .actions { display:none; } }
</style></head>
<body>
  <div class="actions"><button onclick="window.print()">In</button></div>
  <div class="label">
    <img class="qr" src="${qr}" alt="QR ${escapeHtml(it.name)}"/>
    <div>
      <h1>${escapeHtml(it.name)}</h1>
      <div class="addr">${escapeHtml(it.address||'')}</div>
      <div class="meta">C√°n b·ªô: ${escapeHtml(it.officer||'')} ‚Ä¢ Nh√≥m: ${escapeHtml(it.group||'')}</div>
      <div class="meta">M√£ KH: ${escapeHtml(it.customerCode||'')} ‚Ä¢ SƒêT: ${escapeHtml(it.phone||'')}</div>
      <div class="meta">CCCD: ${escapeHtml(it.cccd||'')}</div>
      <div class="meta">Ghi ch√∫: ${escapeHtml(it.note||'')}</div>
      <div class="code">Maps: ${escapeHtml(it.mapsUrl)}</div>
    </div>
  </div>
</body></html>`);
  win.document.close();
}

// ===== Map helpers (kh√¥ng c·∫ßn copy URL) =====
function gmLinkFromLatLng(lat, lng){ return `https://www.google.com/maps/search/?api=1&query=${lat.toFixed(6)},${lng.toFixed(6)}`; }
function openMapsTab(){ const addr = document.getElementById('address').value.trim(); const url = addr ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addr)}` : 'https://maps.google.com/'; window.open(url, '_blank'); }
function useCurrentPosition(){ if (!('geolocation' in navigator)) return alert('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã.'); navigator.geolocation.getCurrentPosition(async pos => { const { latitude:lat, longitude:lng } = pos.coords || {}; document.getElementById('mapsUrl').value = gmLinkFromLatLng(lat, lng); try{ const addr = await reverseGeocode(lat, lng); if (addr && !document.getElementById('address').value) document.getElementById('address').value = addr; }catch{} }, ()=> alert('Kh√¥ng l·∫•y ƒë∆∞·ª£c v·ªã tr√≠ hi·ªán t·∫°i.'), { enableHighAccuracy:true, timeout:10000, maximumAge:0 }); }
let map, marker, picked; function openPickOnMap(){ const modal = document.getElementById('mapModal'); modal.classList.remove('hidden'); setTimeout(()=>{ if (!map){ map = L.map('map'); const vn = [21.0278,105.8342]; map.setView(vn, 13); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map); map.on('click', (e)=> setPicked(e.latlng)); if (navigator.geolocation){ navigator.geolocation.getCurrentPosition(pos=>{ const ll = [pos.coords.latitude, pos.coords.longitude]; map.setView(ll, 16); setPicked({ lat: ll[0], lng: ll[1] }); }); } } setTimeout(()=> map.invalidateSize(), 150); }, 0); }
function closePickOnMap(){ document.getElementById('mapModal').classList.add('hidden'); }
function setPicked(latlng){ picked = latlng; if (!marker){ marker = L.marker(latlng).addTo(map); } else { marker.setLatLng(latlng); } document.getElementById('pickedInfo').textContent = `ƒê√£ ch·ªçn: ${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`; }
async function reverseGeocode(lat, lng){ const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`, { headers: { 'Accept':'application/json' } }); if (!res.ok) return ''; const j = await res.json(); return j.display_name || ''; }
async function searchPlaceByText(q){ const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1`, { headers: { 'Accept':'application/json' } }); if (!res.ok) return null; const arr = await res.json(); if (!arr || !arr[0]) return null; return { lat: parseFloat(arr[0].lat), lng: parseFloat(arr[0].lon), label: arr[0].display_name }; }

document.getElementById('btnUseCurrent').addEventListener('click', useCurrentPosition);

document.getElementById('btnPickOnMap').addEventListener('click', openPickOnMap);

document.getElementById('btnOpenMaps').addEventListener('click', openMapsTab);

document.getElementById('btnCloseModal').addEventListener('click', closePickOnMap);

document.getElementById('btnUseCoords').addEventListener('click', ()=>{ if (!picked) return alert('H√£y b·∫•m v√†o b·∫£n ƒë·ªì ƒë·ªÉ ch·ªçn v·ªã tr√≠.'); document.getElementById('mapsUrl').value = gmLinkFromLatLng(picked.lat, picked.lng); closePickOnMap(); });

document.getElementById('btnReverseAddress').addEventListener('click', async ()=>{ if (!picked) return alert('Ch∆∞a c√≥ t·ªça ƒë·ªô.'); const addr = await reverseGeocode(picked.lat, picked.lng); if (addr) document.getElementById('address').value = addr; });

document.getElementById('searchPlace').addEventListener('keydown', async (e)=>{ if (e.key !== 'Enter') return; e.preventDefault(); const q = e.target.value.trim(); if (!q) return; const r = await searchPlaceByText(q); if (!r) return alert('Kh√¥ng t√¨m th·∫•y ƒë·ªãa ch·ªâ.'); map.setView([r.lat, r.lng], 17); setPicked({ lat:r.lat, lng:r.lng }); });

// ===== Quick Print (kh√¥ng l∆∞u) =====
document.getElementById('btnQuickPrint').addEventListener('click', async ()=>{
  const officer = document.getElementById('officer').value.trim();
  const name = document.getElementById('name').value.trim();
  const address = document.getElementById('address').value.trim();
  const mapsUrlInput = document.getElementById('mapsUrl').value.trim();
  const phone = normalizePhone(document.getElementById('phone').value.trim());
  const group = document.getElementById('group').value.trim();
  const customerCode = document.getElementById('customerCode').value.trim();
  const cccd = normalizeCCCD(document.getElementById('cccd').value.trim());
  const note = document.getElementById('note').value.trim();
  const mapsUrl = mapsUrlInput || (address? mapsUrlFromAddress(address):'');
  if (!name || !mapsUrl){ return alert('ƒê·ªÉ In QR nhanh: c·∫ßn √≠t nh·∫•t T√™n v√† (ƒê·ªãa ch·ªâ ho·∫∑c Link Maps).'); }
  const it = { name, address, mapsUrl, officer, group, customerCode, cccd, phone, note };
  let qr = '';
  try { qr = await makeQRDataUrl(mapsUrl, 1024); } catch(e) { alert('Kh√¥ng t·∫°o ƒë∆∞·ª£c QR (m·∫°ng ch·∫≠m). Th·ª≠ l·∫°i sau v√†i gi√¢y.'); return; }
  const win = window.open('', '_blank');
  win.document.write(`<!doctype html>
<html><head><meta charset="utf-8"><title>In nh√£n nhanh ‚Äì ${escapeHtml(it.name)}</title>
<style>
  @page { size: A7; margin: 6mm; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin:0; }
  .label { display:flex; gap:12px; align-items:center; padding: 10px; }
  .qr { width:180px; height:180px; object-fit:contain; border:1px solid #eee; border-radius:12px; }
  h1 { font-size:20px; margin:0 0 4px; }
  .addr { color:#444; }
  .meta { font-size:12px; color:#555; margin-top:6px; }
  .code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; color:#666; font-size:12px; margin-top:4px; }
  .actions { position: fixed; top:10px; right:10px; }
  @media print { .actions { display:none; } }
</style></head>
<body>
  <div class="actions"><button onclick="window.print()">In</button></div>
  <div class="label">
    <img class="qr" src="${qr}" alt="QR ${escapeHtml(it.name)}"/>
    <div>
      <h1>${escapeHtml(it.name)}</h1>
      <div class="addr">${escapeHtml(it.address||'')}</div>
      <div class="meta">C√°n b·ªô: ${escapeHtml(it.officer||'')} ‚Ä¢ Nh√≥m: ${escapeHtml(it.group||'')}</div>
      <div class="meta">M√£ KH: ${escapeHtml(it.customerCode||'')} ‚Ä¢ SƒêT: ${escapeHtml(it.phone||'')}</div>
      <div class="meta">CCCD: ${escapeHtml(it.cccd||'')}</div>
      <div class="meta">Ghi ch√∫: ${escapeHtml(it.note||'')}</div>
      <div class="code">Maps: ${escapeHtml(it.mapsUrl)}</div>
    </div>
  </div>
</body></html>`);
  win.document.close();
});

document.getElementById('btnClearAll').addEventListener('click', () => {
  if (!confirm('X√≥a to√†n b·ªô d·ªØ li·ªáu ƒëang l∆∞u trong tr√¨nh duy·ªát?')) return;
  items = []; saveItems(items); renderTable();
});

async function delItem(id){
  const it = items.find(x=>x.id===id); if (!it) return;
  const officer = prompt('Nh·∫≠p t√™n C√°n b·ªô ƒë√£ t·∫°o m·ª•c n√†y:') || '';
  const pin = prompt('Nh·∫≠p PIN (n·∫øu c√≥):') || '';
  if (String(officer).trim() !== String(it.officer).trim()) return alert('Kh√¥ng ƒë√∫ng C√°n b·ªô t·∫°o.');
  if (it.pinHash){
    const ok = (await sha256Hex((it.pinSalt||'') + pin)) === it.pinHash;
    if (!ok) return alert('PIN kh√¥ng ƒë√∫ng.');
  }
  if (!confirm('X√≥a m·ª•c n√†y?')) return;
  items = items.filter(x => x.id !== id);
  saveItems(items); renderTable();
}

async function editItem(id){
  const it = items.find(x=>x.id===id); if (!it) return;
  const officer = prompt('Nh·∫≠p t√™n C√°n b·ªô (ƒë√£ t·∫°o):') || '';
  const pin = prompt('Nh·∫≠p PIN (n·∫øu c√≥):') || '';
  if (String(officer).trim() !== String(it.officer).trim()) return alert('Kh√¥ng ƒë√∫ng C√°n b·ªô t·∫°o.');
  if (it.pinHash){
    const ok = (await sha256Hex((it.pinSalt||'') + pin)) === it.pinHash;
    if (!ok) return alert('PIN kh√¥ng ƒë√∫ng.');
  }
  const name = prompt('T√™n ƒë·ªãa ƒëi·ªÉm:', it.name) ?? it.name;
  const address = prompt('ƒê·ªãa ch·ªâ:', it.address||'') ?? it.address;
  const mapsUrl = prompt('Link Maps:', it.mapsUrl||'') ?? it.mapsUrl;
  const note = prompt('Ghi ch√∫:', it.note||'') ?? it.note;
  const phone = prompt('SƒêT:', it.phone||'') ?? it.phone;
  const group = prompt('Nh√≥m:', it.group||'') ?? it.group;
  const cccd = prompt('CCCD:', it.cccd||'') ?? it.cccd;
  const customerCode = prompt('M√£ KH:', it.customerCode||'') ?? it.customerCode;
  Object.assign(it, { name, address, mapsUrl, note, phone, group, cccd, customerCode });
  saveItems(items); renderTable();
}

function renderTable(){
  const wrap = document.getElementById('list');
  let arr = items.slice();
  const q = document.getElementById('q').value.trim().toLowerCase();
  if (q){ arr = arr.filter(x => [x.name,x.group,x.customerCode,x.phone,x.officer].some(v => String(v||'').toLowerCase().includes(q))); }
  if (!arr.length){ wrap.innerHTML = '<div class="empty">Ch∆∞a c√≥ m·ª•c n√†o</div>'; return; }
  wrap.innerHTML = `
    <table>
      <thead><tr>
        <th><input type="checkbox" id="selAll" title="Ch·ªçn/B·ªè ch·ªçn t·∫•t c·∫£"></th>
        <th>QR</th>
        <th>T√™n</th>
        <th>ƒê·ªãa ch·ªâ</th>
        <th>C√°n b·ªô</th>
        <th>Nh√≥m</th>
        <th>M√£ KH</th>
        <th>SƒêT</th>
        <th>CCCD</th>
        <th>Link Maps</th>
        <th>M√£</th>
        <th>H√†nh ƒë·ªông</th>
      </tr></thead>
      <tbody>
        ${arr.map(x => `
          <tr>
            <td><input type="checkbox" class="sel" data-id="${x.id}" ${selectedIds.has(x.id)?'checked':''}></td>
            <td><img class="qr" src="" data-code="${x.code}" /></td>
            <td>${escapeHtml(x.name)}<div class="muted">${escapeHtml(x.note||'')}</div></td>
            <td>${escapeHtml(x.address||'')}</td>
            <td>${escapeHtml(x.officer||'')}</td>
            <td>${escapeHtml(x.group||'')}</td>
            <td class="code">${escapeHtml(x.customerCode||'')}</td>
            <td>${escapeHtml(x.phone||'')}</td>
            <td>${escapeHtml(x.cccd||'')}</td>
            <td><a class="code" href="${x.mapsUrl}" target="_blank">M·ªü</a></td>
            <td class="code">${x.code}</td>
            <td class="inline-btns">
              <button data-act="print-qr" data-code="${x.code}">In QR</button>
              <span class="sep">|</span>
              <button data-act="print-full" data-code="${x.code}">In ƒë·∫ßy ƒë·ªß</button>
              <span class="sep">|</span>
              <button data-act="download" data-url="${escapeHtml(x.mapsUrl)}" data-code="${x.code}">T·∫£i QR</button>
              <span class="sep">|</span>
              <button data-act="edit" data-id="${x.id}">S·ª≠a</button>
              <span class="sep">|</span>
              <button class="btn-danger" data-act="delete" data-id="${x.id}">X√≥a</button>
            </td>
          </tr>
        `).join('')}
      </tbody>
    </table>`;
  const imgs = wrap.querySelectorAll('img.qr');
  imgs.forEach(async img => {
    const code = img.getAttribute('data-code'); const it = items.find(x => x.code === code); if (!it) return;
    try{ img.src = await makeQRDataUrl(it.mapsUrl, 256); }
    catch{ setTimeout(async ()=>{ try{ img.src = await makeQRDataUrl(it.mapsUrl, 256); }catch{} }, 2500); }
  });
  const selAll = document.getElementById('selAll');
  selAll.addEventListener('change', ()=>{ if (selAll.checked){ arr.forEach(x=> selectedIds.add(x.id)); } else { arr.forEach(x=> selectedIds.delete(x.id)); } renderTable(); });
  wrap.querySelectorAll('input.sel').forEach(cb=>{ cb.addEventListener('change', (e)=>{ const id = e.target.getAttribute('data-id'); if (e.target.checked) selectedIds.add(id); else selectedIds.delete(id); }); });
  // Delegated actions (kh√¥ng ph·ª• thu·ªôc inline onclick)
  wrap.querySelectorAll('[data-act]').forEach(btn=>{
    btn.addEventListener('click', async (e)=>{
      const act = e.currentTarget.getAttribute('data-act');
      if (act==='print-qr'){ return openPrint(e.currentTarget.getAttribute('data-code'),'qr'); }
      if (act==='print-full'){ return openPrint(e.currentTarget.getAttribute('data-code'),'full'); }
      if (act==='download'){ return downloadQR(e.currentTarget.getAttribute('data-url'), 'qr_'+e.currentTarget.getAttribute('data-code')+'.png'); }
      if (act==='edit'){ return editItem(e.currentTarget.getAttribute('data-id')); }
      if (act==='delete'){ return delItem(e.currentTarget.getAttribute('data-id')); }
    });
  });
}

// ===== QR Scan (image) =====
const btnScan = document.getElementById('btnScan');
const scanFile = document.getElementById('scanFile');
btnScan.addEventListener('click', ()=> scanFile.click());
scanFile.addEventListener('change', async (e)=>{
  const file = e.target.files?.[0]; if (!file) return;
  try {
    if ('BarcodeDetector' in window){
      const det = new BarcodeDetector({ formats: ['qr_code'] });
      const bmp = await createImageBitmap(file);
      const cvs = document.createElement('canvas'); cvs.width = bmp.width; cvs.height = bmp.height; const ctx = cvs.getContext('2d'); ctx.drawImage(bmp,0,0); const codes = await det.detect(cvs);
      if (codes && codes[0]){ document.getElementById('mapsUrl').value = codes[0].rawValue; alert('ƒê√£ l·∫•y link t·ª´ QR.'); }
      else alert('Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c QR trong ·∫£nh.');
    } else { alert('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ qu√©t QR tr·ª±c ti·∫øp.'); }
  } catch (err){ console.error(err); alert('Kh√¥ng qu√©t ƒë∆∞·ª£c QR.'); }
  finally { e.target.value=''; }
});

// ===== Footer year =====
const yEl = document.getElementById('yearNow'); if (yEl) yEl.textContent = new Date().getFullYear();

// ===== Self-tests (console) =====
(async function selfTest(){
  try{
    console.assert(Array.isArray(HEADERS) && HEADERS.includes('id') && HEADERS.includes('mapsUrl'), 'HEADERS ok');
    await ensureQRCode(2000).catch(()=>{}); // best effort
    const d = await makeQRDataUrl('https://example.com', 128).catch(()=>null);
    console.assert(!d || (typeof d === 'string' && d.startsWith('data:image/png')), 'QR generate ok (eventually)');
    const demo = mapsUrlFromAddress('H√† N·ªôi'); console.assert(demo.includes('query='), 'mapsUrlFromAddress ok');
    // test base64 helper
    const u8 = new Uint8Array([1,2,3,250,251,252]); const b64 = btoa(String.fromCharCode(...u8)); console.assert(b64 === ab2b64(u8.buffer), 'ab2b64 ok');
  }catch(e){ console.warn('Self-test warning:', e); }
})();
</script>
</body>
</html>
